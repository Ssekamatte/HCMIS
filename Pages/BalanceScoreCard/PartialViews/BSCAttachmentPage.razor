@* <h3>BSCAttachmentPage</h3> *@
@using Blazored.Toast.Services;
@using HCMIS.Data;
@using HCMIS.Interface;

@using HCMIS.SHARED.Data
@using HCMIS.SHARED.Models;
@using HCMIS.ViewModel;
@using Newtonsoft.Json
@using Syncfusion.DocIORenderer;
@using Syncfusion.Pdf;
@inject IToastService toasterservice;
@inject DocumentUploadModel _DocumentUploadModel;
@inject HttpClient Http

@if(DataSource != null)
{
    <SfGrid @ref="BalanceScoreCardAttachmentGrid" DataSource=@DataSource ID="BSCGrid" TValue="BalanceScoreCardAttachment"
            Toolbar="@BSCAttachmentToolbarItems" AllowGrouping="false" ShowColumnChooser="true" AllowTextWrap="true"
            AllowPaging="true" AllowFiltering="true" GridLines="GridLine.Both" AllowSelection="true">
        <GridSelectionSettings Mode="Syncfusion.Blazor.Grids.SelectionMode.Row" Type="Syncfusion.Blazor.Grids.SelectionType.Single"></GridSelectionSettings>
        <GridSearchSettings IgnoreCase="true"></GridSearchSettings>
        <GridEvents 
            OnActionBegin="OnAttachmentActionBegin" 
            OnActionComplete="@OnAttachmentActionComplete"                    
            TValue="BalanceScoreCardAttachment"></GridEvents>
        <GridEditSettings AllowAdding="attachmentgridenabled" AllowDeleting="false" AllowEditing="true" Mode="@EditMode.Dialog"  Dialog="@DialogParams">
            <Template Context="AttachmentContext">
                @{
                    AttachmentData = (AttachmentContext as BalanceScoreCardAttachment);
                    
                    <div style="padding:15px;">
                        <div class="form-row">
                            <div class="form-group col-md-12" hidden>
                                <SfNumericTextBox ID="AttachmentId" @bind-Value="@(AttachmentData.AttachmentId)" Enabled="false" Placeholder="Attachment Id" Format="N0" FloatLabelType="FloatLabelType.Never"></SfNumericTextBox>
                            </div>
                            <div class="form-group col-md-12">
                                <p>Attachment Name <span style="color:red;">*</span></p>
                                <SfTextBox Multiline="true" @bind-Value="@(AttachmentData.AttachmentName)" Enabled="true" Placeholder="Attachment Name" FloatLabelType="FloatLabelType.Never"  Input="@InputHandler"></SfTextBox>
                            </div>

                            @if(attachmentnamebool == true)
                            {
                                <div class="form-group col-md-12">
                                    <p class="alert-info" style="padding:10px;">Ensure that the document does not exceed 1 Mega Byte (MB) and is of the following formats (Microsoft Word, PDF or an Image (png,gif,jpeg and jpg))</p>
                                    <InputFile class="form-control" OnChange="@SingleUpload" />
                                    <div>
                                        <SfSpinner @ref="UploadAttachmentSpinner" CssClass="SpinnerClass" Visible="false" Size="30" Label="Saving document Please wait......."> </SfSpinner>
                                    </div>
                                </div>
                            }
                            
                            <div class="form-group col-md-12">
                                @if (!string.IsNullOrEmpty(ImageString))
                                {
                                    @if (!string.IsNullOrEmpty(AttachmentData.AttachmentUrl) && !string.IsNullOrEmpty(AttachmentData.AttachmentExt))
                                    {
                                        if (AttachmentData.AttachmentExt.Contains("pdf") || AttachmentData.AttachmentExt.Contains("doc") || AttachmentData.AttachmentExt.Contains("docx"))
                                        {
                                            <embed src="@ImageString" width="100%" height="600px" style="border: none;" frameborder="0" allowfullscreen="true" />
                                        }
                                        else
                                        {
                                            <img src="@ImageString" alt="@AttachmentData.AttachmentUrl" class="img-thumbnail Imagecenter" style="margin-bottom:10px; width:100%;" />
                                        }
                                    }
                                    
                                }

                                
                            </div>
                        </div>
                    </div>
                }
            </Template>
            <FooterTemplate Context="AttachmentFooterContext">
                @if(IsSaveDisabled == false)
                {
                    <SfButton CssClass="e-success" Disabled="@IsSaveDisabled" OnClick="@OnSaveDocumentClick">Save Document</SfButton>
                    <SfButton CssClass="e-danger" Disabled="@IsSaveDisabled" OnClick="@OnCloseDocumentClick">Close</SfButton>
                }
                
            </FooterTemplate>
        </GridEditSettings>
        <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
        <GridPageSettings PageSize="20"></GridPageSettings>
        <GridColumns>
            @*<GridColumn Type="ColumnType.CheckBox" Width="50"></GridColumn>*@
            <GridColumn Field=@nameof(BalanceScoreCardAttachment.AttachmentId) HeaderText="Attachment Id" TextAlign="TextAlign.Left" IsPrimaryKey="true" IsIdentity="true" Visible="false" Width="100"></GridColumn>
            <GridColumn Field=@nameof(BalanceScoreCardAttachment.AttachmentName) HeaderText="Attachment"></GridColumn>
            <GridColumn HeaderText="Manage Records" Width="140">
                <GridCommandColumns>
                    <GridCommandColumn Type="CommandButtonType.Edit" ButtonOption="@(new CommandButtonOptions() { CssClass="e-icons e-view-details",Content="View" })" Title="View"></GridCommandColumn>
                    @*@if (!string.IsNullOrEmpty(UserRole) && (UserRole.Contains("Data Entry Officer") || UserRole.Contains("Administrator") || UserRole.Contains("Unit Head") || UserRole.Contains("Responsible Reporting Staff for Division")))
                    {
                        <GridCommandColumn Type="CommandButtonType.Edit" ButtonOption="@(new CommandButtonOptions() { CssClass="e-icons e-view-details",Content="Edit" })" Title="Edit"></GridCommandColumn>
                    }
                    else
                    {
                        <GridCommandColumn Type="CommandButtonType.Edit" ButtonOption="@(new CommandButtonOptions() { CssClass="e-icons e-view-details",Content="View" })" Title="View"></GridCommandColumn>
                    }*@
                </GridCommandColumns>
            </GridColumn>
        </GridColumns>
    </SfGrid>
}

@code {
    // [Parameter]
    // public List<BalanceScoreCardAttachment>? HeaderAttachmentData { get; set; }
    [Parameter]
    public int BalanceScoreCardId { get; set; }
    [Parameter]
    public EventCallback<List<BalanceScoreCardAttachment>?> OnHeaderAttachmentToggled { get; set; }
    SfGrid<BalanceScoreCardAttachment>? BalanceScoreCardAttachmentGrid { get; set; }
    List<BalanceScoreCardAttachment>? DataSource { get; set; }
    BalanceScoreCardAttachment? AttachmentData { get; set; }
    SfSpinner? UploadAttachmentSpinner;
    bool IsSaveDisabled { get; set; }
    [Parameter]
    public bool allowediting { get; set; }
    [Parameter]
    public string? UserRole { get; set; }
    [Parameter]
    public List<object>? BSCAttachmentToolbarItems { get; set; }
    [Parameter]
    public string? AccessToken { get; set; }
    int? PreviousBalanceScoreCardId { get; set; }
    int? AttachmentId { get; set; }

    string? ImageString { get; set; }
    long maxFileSize = 1000000 /* 1000000 - 1 MegaByte*/;
    string fileName = string.Empty;
    int random = -9999;
    private DialogSettings DialogParams = new DialogSettings { Height = "auto", MinHeight = "85vh", Width = "80%" };
    [Parameter]
    public bool attachmentgridenabled { get; set; }
    bool attachmentnamebool = false;
    [Parameter]
    public int selectebscid { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        try
        {
            //toasterservice.ShowError(selectebscid.ToString());
            if (selectebscid > 0)
            {
                await LoadClientsForSelectedGroup();
            }

            // if (PreviousBalanceScoreCardId != BalanceScoreCardId)
            // {
            //     PreviousBalanceScoreCardId = BalanceScoreCardId;
            //     DataSource = new List<BalanceScoreCardAttachment>();
            //     if (HeaderAttachmentData != null && HeaderAttachmentData.Count() > 0)
            //     {
            //         DataSource.AddRange(HeaderAttachmentData);
            //     }
            // }
        }
        catch (Exception ex)
        {

        }
    }

    //On ParameterAsync is called each time the page is referenced
    protected override async Task OnParametersSetAsync()
    {
        //toastService.ShowError("Args is OnPara" + _previous.ToString());
        await base.OnParametersSetAsync();
        try
        {
            if (selectebscid > 0)
            {
                await LoadClientsForSelectedGroup();
            }
        }
        catch (Exception ex)
        {

            //throw;
        }
    }


    private async Task LoadClientsForSelectedGroup()
    {
        var response = await Http.GetAsync($"BalanceScoreCard/GetBSCAttachmentData?selectebscid={selectebscid}");
        if (response.IsSuccessStatusCode)
        {
            var responseData = await response.Content.ReadAsStringAsync();
            DataSource = JsonConvert.DeserializeObject<List<BalanceScoreCardAttachment>>(responseData);
        }
        else
        {
            // Handle API error
            // You can display an error message or log the error
        }
    }

    private void InputHandler(InputEventArgs args)
    {
        if (string.IsNullOrEmpty(args.Value))
        {
            attachmentnamebool = false;
        }
        else
        {
            attachmentnamebool = true;
        }        
    }

    private async Task OnSaveDocumentClick()
    {
        if (BalanceScoreCardAttachmentGrid != null)
        {
            await BalanceScoreCardAttachmentGrid.EndEditAsync();
        }
    }
    private async Task OnCloseDocumentClick()
    {
        if (BalanceScoreCardAttachmentGrid != null)
        {
            await BalanceScoreCardAttachmentGrid.CloseEditAsync();
        }
    }

    public async Task OnAttachmentActionBegin(Syncfusion.Blazor.Grids.ActionEventArgs<BalanceScoreCardAttachment> args)
    {
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.BeginEdit)
        {

        }
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.Add)
        {
            attachmentnamebool = false;
            args.Data.AttachmentId = random;
            random++;
        }
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.Cancel)
        {

        }
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.Save)
        {
            if (string.IsNullOrEmpty(args.Data.AttachmentName))
            {
                toasterservice.ClearAll();
                toasterservice.ShowWarning("Please enter the Report/Attachment Name");
                args.Cancel = true;
            }
            // else if (string.IsNullOrEmpty(args.Data.AttachmentUrl))
            // {
            //     toasterservice.ShowWarning("Please enter upload the Report/attachment");
            //     args.Cancel = true;
            // }
            else
            {
                //args.Data.BalanceScoreCardId = BalanceScoreCardId.Value;
            }
        }
    }


    public async Task OnAttachmentActionComplete(Syncfusion.Blazor.Grids.ActionEventArgs<BalanceScoreCardAttachment> args)
    {
        if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add) || args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.BeginEdit))
        {
            BalanceScoreCardAttachmentGrid.PreventRender(false);
            if (!string.IsNullOrEmpty(args.RowData.AttachmentUrl) && !string.IsNullOrEmpty(args.RowData.AttachmentExt))
            {
                ImageString = await GetImageString(args.RowData.AttachmentUrl, args.RowData.AttachmentExt, "BSC");
            }
        }
        else if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Save) || args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Refresh))
        {
            await OnHeaderAttachmentToggled.InvokeAsync(DataSource);
        }
    }

    
    private async Task SingleUpload(InputFileChangeEventArgs e)
    {
        try
        {   
            // IsSaveDisabled = true;
            await UploadAttachmentSpinner.ShowAsync();
            MemoryStream ms = new MemoryStream();
            //await e.File.OpenReadStream(maxFileSize).CopyToAsync(ms);

            if(e.File.Size <= maxFileSize)
            {
                IsSaveDisabled = false;
                await e.File.OpenReadStream(maxFileSize).CopyToAsync(ms);

                ms.Position = 0;

                System.IO.FileInfo info = new System.IO.FileInfo(e.File.Name);
                if (info.Extension.ToLower().Contains("png") || info.Extension.ToLower().Contains("gif") || info.Extension.ToLower().Contains("jpeg") || info.Extension.ToLower().Contains("jpg"))
                {
                    fileName = "BSC_" + AttachmentData.AttachmentName + info.Extension.Trim();
                    byte[] bytes = ms.ToArray();
                    //byte[] bytes = file.Stream.ToArray();
                    string base64 = Convert.ToBase64String(bytes, 0, bytes.Length);
                    DocumentBytes m = new DocumentBytes()
                        {
                            DocumentName = fileName,
                            DocumentExt = info.Extension.Trim(),
                            DocumentByte = bytes,
                            DocumentFolder = "BSC"
                        };

                    await _DocumentUploadModel.UploadDocument(m);
                    var result = "data:application/pdf;base64," + base64;
                    AttachmentData.AttachmentUrl = fileName;
                    AttachmentData.AttachmentExt = info.Extension.Trim();
                    ImageString = result;
                    bytes = null;

                }

                else if (info.Extension.ToLower().Contains("pdf") || info.Extension.ToLower().Contains("doc"))
                {
                    string fileName = string.Empty;
                    if (info.Extension.ToLower().Contains("doc"))
                    {
                        ms.Position = 0;
                        fileName = "BSC_" + AttachmentData.AttachmentName + ".pdf";
                        //Create a new document
                        Syncfusion.DocIO.DLS.WordDocument document;
                        if (info.Extension.Contains("doc") && !info.Extension.Contains("docx"))
                        {
                            document = new Syncfusion.DocIO.DLS.WordDocument(ms, Syncfusion.DocIO.FormatType.Doc);
                        }
                        else
                        {
                            document = new Syncfusion.DocIO.DLS.WordDocument(ms, Syncfusion.DocIO.FormatType.Docx);
                        }
                        //Creates an instance of the DocToPDFConverter
                        DocIORenderer render = new DocIORenderer();//Converts Word document into PDF document
                        PdfDocument pdfDocument = render.ConvertToPDF(document);

                        MemoryStream _ms = new MemoryStream();
                        pdfDocument.Save(_ms);
                        _ms.Position = 0;


                        DocumentBytes m = new DocumentBytes();
                        m.DocumentName = fileName;
                        m.DocumentFolder = "BSC";
                        m.DocumentByte = _ms.ToArray();
                        m.DocumentExt = "pdf";

                        await _DocumentUploadModel.UploadDocument(m);
                        _ms.Position = 0;
                        byte[] _bytes = _ms.ToArray();
                        string base64 = Convert.ToBase64String(_bytes, 0, _bytes.Length);

                        var result = "data:application/pdf;base64," + base64;
                        AttachmentData.AttachmentUrl = fileName;
                        AttachmentData.AttachmentExt = "pdf";
                        ImageString = result;
                    }

                    else
                    {
                        fileName = "BSC_" + AttachmentData.AttachmentName + ".pdf";

                        ms.Position = 0;
                        byte[] bytes = ms.ToArray();
                        string base64 = Convert.ToBase64String(bytes, 0, bytes.Length);

                        DocumentBytes m = new DocumentBytes()
                            {
                                DocumentName = fileName,
                                DocumentExt = info.Extension.Trim(),
                                DocumentByte = bytes,
                                DocumentFolder = "BSC"
                            };

                        await _DocumentUploadModel.UploadDocument(m);
                        var result = "data:application/pdf;base64," + base64;
                        AttachmentData.AttachmentUrl = fileName;
                        AttachmentData.AttachmentExt = info.Extension.Trim();
                        ImageString = result;
                        bytes = null;
                    }

                }
                else
                {
                    toasterservice.ClearAll();
                    toasterservice.ShowWarning("Please ensure that the uploaded document is an image(png/Jpeg/gif/jpg) or pdf or word document (doc,docx).");
                }

            }
            else
            {
                IsSaveDisabled = true;
                toasterservice.ClearAll();
                toasterservice.ShowWarning("File Too Large (Maximum Size 1 MB)");
            }

        }
        catch (Exception ex)
        {
            throw ex;
        }

        finally
        {
            //IsSaveDisabled = false;
            await UploadAttachmentSpinner.HideAsync();
            StateHasChanged();
        }

    }

    private async Task<string> GetImageString(string imageUrl, string ext, string DocumentFolder)
    {
        string result = null;
        try
        {
            if (!string.IsNullOrEmpty(imageUrl))
            {
                var a = await _DocumentUploadModel.GetDocument(imageUrl, DocumentFolder);

                if (a != null && !string.IsNullOrEmpty(a.DocumentExt))
                {
                    if (a.DocumentExt.Contains("pdf"))
                    {
                        string base64String = Convert.ToBase64String(a.DocumentByte, 0, a.DocumentByte.Length);
                        result = "data:application/pdf;base64," + base64String;
                    }
                    else
                    {
                        string base64String = Convert.ToBase64String(a.DocumentByte, 0, a.DocumentByte.Length);
                        result = "data:image/" + a.DocumentExt + ";base64," + base64String;
                    }

                }
                else
                {
                    toasterservice.ShowError("Attachment Not Found");
                }
            }
        }
        catch (Exception ex)
        {
            toasterservice.ClearAll();
            toasterservice.ShowError(ex.Message.ToString());
        }
        return result;
    }

    
}
