@page "/AptitudeTestPage"
@using HCMIS.Interface;
@using HCMIS.Repository

@using HCMIS.SHARED.Data;
@using HCMIS.SHARED.Models;
@using HCMIS.ViewModel
@using System.Text.Json
@using System.Collections
@inject HttpClient http;
@inject ISettingsRepository settingsRepo;
@inject DocumentUploadModel _DocumentUploadModel;
@inject IToastService toasterservice;


<style>
    h3 {
        color: ghostwhite;
        background-color: #00cc00;
        padding: 10px;
        width: 100%;
        font-size: large;
    }
    label {
        margin-top:6px;
        margin-bottom:6px;
    }
</style>
<PageTitle>Aptitude Tests</PageTitle>

<BreadcrumbPage CategoryName="Human Resource" PageName="Aptitude Tests" />
<div class="row">
    <div class="col-lg-12 control-section">
        <SfToast @ref="ToastObj" ID="toast_type">
            <ToastPosition X="@ToastPosition"></ToastPosition>
        </SfToast>
    </div>
</div>
<div class="row">
    <div class="col-md-12">

    </div>
    <div class="col-md-12">
        <SfGrid @ref=@AptituddeTestHeaderGrid TValue="AptituddeTestModel" AllowGrouping="false" ShowColumnChooser="true" AllowTextWrap="true"
                AllowPaging="true" AllowFiltering="true" GridLines="GridLine.Both" AllowSelection="true"
                Toolbar="@(new string[] {"Add"})">
            <SfDataManager AdaptorInstance="@typeof(AptituddeTestAdapter)" Adaptor="Adaptors.CustomAdaptor"></SfDataManager>
            <GridSelectionSettings Mode="Syncfusion.Blazor.Grids.SelectionMode.Row" Type="Syncfusion.Blazor.Grids.SelectionType.Single"></GridSelectionSettings>
            <GridSearchSettings IgnoreCase="true"></GridSearchSettings>
            <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
            <GridPageSettings PageSize="20"></GridPageSettings>
            <GridEvents OnActionComplete="@OnAptituddeTestActionComplete" OnActionBegin="@OnAptituddeTestActionBegin" TValue="AptituddeTestModel"></GridEvents>
            <GridEditSettings AllowAdding="true" AllowDeleting="false" AllowEditing="true" Mode="@EditMode.Dialog" Dialog="DialogParams">
                <Template>
                    @{
                        HeaderReviewData = (context as AptituddeTestModel)?.Aptituddetestheader;
                        if((context as AptituddeTestModel).Aptituddetestquestions == null)
                        {
                            (context as AptituddeTestModel).Aptituddetestquestions = new();
                        }
                        if(HeaderReviewData != null){
                                    <div class="row" style="margin:10px;">
                                        <div class="col-md-12" hidden>
                                            <SfNumericTextBox @bind-Value="@(HeaderReviewData.AptituddeTestHeaderId)" Enabled="false" Placeholder="Id" Format="N0" FloatLabelType="FloatLabelType.Always"></SfNumericTextBox>
                                        </div>
                                        <div class="col-md-4">
                                        <p>Department <span style="color:red;">*</span></p>
                                            <SfDropDownList @bind-Value="@(HeaderReviewData.DepartmentId)" Enabled="true" TItem="ADepartment" TValue="int?" DataSource="@DepartmentData" Placeholder="Please select" FloatLabelType="FloatLabelType.Never" AllowFiltering="true" FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains">
                                                <DropDownListFieldSettings Value="@nameof(ADepartment.DepartmentId)" Text="@nameof(ADepartment.DepartmentDescription)"></DropDownListFieldSettings>
                                                <DropDownListEvents TItem="ADepartment" TValue="int?" ValueChange="@DepartmentValueChangeHandler"></DropDownListEvents>
                                            </SfDropDownList>
                                        </div>
                                        <div class="col-md-4">
                                            <p>Job Title <span style="color:red;">*</span></p>
                                            <SfDropDownList @bind-Value="@(HeaderReviewData.JobTitleId)"  Query="@(JobTitleChildQuery)" Enabled="true" TItem="AJobTitle" TValue="int?" DataSource="@JobTitleData" Placeholder="Please select" FloatLabelType="FloatLabelType.Never" AllowFiltering="true" FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains">
                                                <DropDownListFieldSettings Value="@nameof(AJobTitle.JobTitleId)" Text="@nameof(AJobTitle.JobTitleDescription)"></DropDownListFieldSettings>
                                            </SfDropDownList>
                                        </div>
                                        <div class="col-md-4">
                                            <p>Pass mark (%) <span style="color:red;">*</span></p>
                                            <SfNumericTextBox @bind-Value="@(HeaderReviewData.PassMark)" Enabled="true" Placeholder="Enter Percentage" Format="N0" FloatLabelType="FloatLabelType.Never" Min="0" Max="100"></SfNumericTextBox>
                                        </div>
                                        <div class="col-md-12">
                                            <p>Summary <span style="color:red;">*</span></p>
                                            <SfRichTextEditor Height="200px" ShowCharCount="true" @bind-Value="@(HeaderReviewData.TestSummary)" Placeholder="Type something..." EnableResize=true EditorMode="EditorMode.HTML">
                                                <RichTextEditorQuickToolbarSettings Link="@Link" />
                                                <RichTextEditorToolbarSettings Type="@Tooltype" Items="@Tools" Enable=true   EnableFloating="true" />
                                            </SfRichTextEditor>
                                        </div>
                                        <div class="col-md-4">
                                            <p>Duration <span style="color:red;">*</span></p>
                                            <SfNumericTextBox @bind-Value="@(HeaderReviewData.TestDuration)" Enabled="true" Placeholder="Enter Number" Min="0" Format="N0" FloatLabelType="FloatLabelType.Never"></SfNumericTextBox>
                                        </div>
                                        <div class="col-md-4">
                                            <p>Duration Type <span style="color:red;">*</span></p>
                                            <SfDropDownList @bind-Value="@(HeaderReviewData.DurationTypeId)" Enabled="true" TItem="ADurationType" TValue="int?" DataSource="@DurationTypeData" Placeholder="Please select" FloatLabelType="FloatLabelType.Never" AllowFiltering="true" FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains">
                                                <DropDownListFieldSettings Value="@nameof(ADurationType.DurationTypeId)" Text="@nameof(ADurationType.DurationTypeDesc)"></DropDownListFieldSettings>
                                            </SfDropDownList>
                                        </div>
                                        <div class="col-md-4">
                                            <p>No of Question per session <span style="color:red;">*</span></p>
                                            <SfNumericTextBox @bind-Value="@(HeaderReviewData.NoOfQuestionsPerSession)" Enabled="true" Placeholder="Enter No" Min="0" Format="N0" FloatLabelType="FloatLabelType.Never"></SfNumericTextBox>
                                        </div>
                                        <div class="col-md-12" style="margin-top: 10px;">
                                            <h3>Aptitude Question</h3>
                                        </div>

                                        <div class="col-md-12">
                                            <SfGrid @ref=@AptituddeTestQuestionGrid TValue="AptituddeTestQuestionModel" DataSource="@((context as AptituddeTestModel)?.Aptituddetestquestions)" AllowGrouping="false" ShowColumnChooser="true" AllowTextWrap="true"
                                            AllowPaging="true" AllowFiltering="true" GridLines="GridLine.Both" AllowSelection="true"
                                            Toolbar="@(new string[] {"Add"})">
                                                <GridSelectionSettings Mode="Syncfusion.Blazor.Grids.SelectionMode.Row" Type="Syncfusion.Blazor.Grids.SelectionType.Single"></GridSelectionSettings>
                                                <GridSearchSettings IgnoreCase="true"></GridSearchSettings>
                                                <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
                                                <GridPageSettings PageSize="20"></GridPageSettings>
                                                <GridEvents OnActionComplete="@OnQuestionActionComplete" OnActionBegin="@OnQuestionActionBegin" TValue="AptituddeTestQuestionModel"></GridEvents>
                                                <GridEditSettings AllowAdding="true" AllowDeleting="false" AllowEditing="true" Mode="@EditMode.Dialog" Dialog="DialogParams">
                                                    <Template Context="QuestionContext">
                                                @{
                                                    QuestionReviewData = (QuestionContext as AptituddeTestQuestionModel)?.Aptituddetestquestions;
                                                    if((QuestionContext as AptituddeTestQuestionModel).Aptituddetestquestionanswers == null)
                                                    {
                                                        (QuestionContext as AptituddeTestQuestionModel).Aptituddetestquestionanswers=new();
                                                    }
                                                    if (QuestionReviewData != null)
                                                    {
                                                                        <div class="row" style="margin:10px;">
                                                                            <div class="col-md-12" hidden>
                                                                                <SfNumericTextBox @bind-Value="@(QuestionReviewData.AptituddeTestQuestionId)" Enabled="false" Placeholder="Id" Format="N0" FloatLabelType="FloatLabelType.Always"></SfNumericTextBox>
                                                                            </div>
                                                                            <div class="col-md-12">
                                                                                <p>Dificulty Level</p>
                                                                                <SfDropDownList @bind-Value="@(QuestionReviewData.DifficultyLevelId)" Enabled="true" TItem="ADifficultyLevel" TValue="int?" DataSource="@DifficultyLevelData" Placeholder="Please select" FloatLabelType="FloatLabelType.Never" AllowFiltering="true" FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains">
                                                                                    <DropDownListFieldSettings Value="@nameof(ADifficultyLevel.DifficultyLevelId)" Text="@nameof(ADifficultyLevel.DifficultyLevelDesc)"></DropDownListFieldSettings>
                                                                                </SfDropDownList>
                                                                            </div>
                                                                            <div class="col-md-12">
                                                                                <p>Question</p>
                                                                                <SfRichTextEditor Height="200px" ShowCharCount="true" @bind-Value="@(QuestionReviewData.Question)" Placeholder="Type something..." EnableResize=true EditorMode="EditorMode.HTML">
                                                                                    <RichTextEditorQuickToolbarSettings Link="@Link" />
                                                                                    <RichTextEditorToolbarSettings Type="@Tooltype" Items="@Tools" Enable=true   EnableFloating="true" />
                                                                                </SfRichTextEditor>
                                                                            </div>

                                                                            <div class="form-group col-md-12">
                                                                                        <p class="alert-info" style="padding:10px;">Ensure that the image does not exceed 1 Mega Byte (MB) and is of the following formats (png,gif,jpeg and jpg))</p>
                                                                                        <InputFile class="form-control" OnChange="@SingleUpload" />
                                                                                        <div>
                                                                                            <SfSpinner @ref="UploadAttachmentSpinner" CssClass="SpinnerClass" Visible="false" Size="30" Label="Saving document Please wait......."> </SfSpinner>
                                                                                        </div>
                                                                            </div>

                                                                            <div class="form-group col-md-12">
                                                                                @if (!string.IsNullOrEmpty(ImageString))
                                                                                {                                                                                    
                                                                                    if (!string.IsNullOrEmpty(QuestionReviewData.QuestionImageName))
                                                                                    {
                                                                                        <img src="@ImageString" class="img-thumbnail" height="700" width="700" style="margin-bottom:10px; margin:10%; margin-right:auto;" />
                                                                                    }
                                                                                }

                                                                            </div>

                                                                            <div class="col-md-4">
                                                                                <p>Score</p>
                                                                                <SfNumericTextBox @bind-Value="@(QuestionReviewData.QuestionMark)" Enabled="true" Placeholder="Score" Format="N0" FloatLabelType="FloatLabelType.Never"></SfNumericTextBox>
                                                                            </div>
                                                                            <div class="col-md-4" style="padding-top:15px;">
                                                                                <SfCheckBox @bind-Checked=@QuestionReviewData.IsAmultiselectQuestion Label="Allows Multiple answers" LabelPosition="Syncfusion.Blazor.Buttons.LabelPosition.After" />
                                                                            </div>
                                                                            <div class="col-md-12" style="margin-top: 10px;">
                                                                                <h3>Answers</h3>
                                                                            </div>
                                                                            <div>
                                                                                <SfGrid @ref=@AptituddeTestAnswerGrid TValue="AptituddeTestQuestionAnswers" DataSource="@((QuestionContext as AptituddeTestQuestionModel)?.Aptituddetestquestionanswers)" AllowGrouping="false" ShowColumnChooser="true" AllowTextWrap="true"
                                                                                AllowPaging="true" AllowFiltering="true" GridLines="GridLine.Both" AllowSelection="true"
                                                                                Toolbar="@(new string[] {"Add"})">
                                                                                <GridSelectionSettings Mode="Syncfusion.Blazor.Grids.SelectionMode.Cell" Type="Syncfusion.Blazor.Grids.SelectionType.Single"></GridSelectionSettings>
                                                                                <GridSearchSettings IgnoreCase="true"></GridSearchSettings>
                                                                                <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
                                                                                <GridPageSettings PageSize="20"></GridPageSettings>
                                                                                    @*<GridEvents OnActionComplete="@OnAnswerActionComplete" OnActionBegin="@OnAnswerActionBegin" TValue="AptituddeTestQuestionAnswers"></GridEvents>*@

                                                                                    <GridEvents 
                                                                                        CellSelected="CellSelectHandler"
                                                                                        CellSaved="CellSavedHandler"
                                                                                        OnBatchAdd="BatchAddHandler"
                                                                                        CommandClicked="OnCommandClicked"
                                                                                        OnActionComplete="@OnAnswerActionComplete"
                                                                                        TValue="AptituddeTestQuestionAnswers">
                                                                                    </GridEvents>

                                                                                    <GridEditSettings AllowAdding="true" AllowDeleting="false" AllowEditing="true" Mode="@EditMode.Batch" Dialog="DialogParams" ShowConfirmDialog=false  NewRowPosition="NewRowPosition.Bottom">
                                                                                        <Template Context="AnswerContext">
                                                                                        @{
                                                                                             AnswerReviewData = (AnswerContext as AptituddeTestQuestionAnswers);
                                                                                            if (AnswerReviewData != null)
                                                                                            {
                                                                                                                        <div class="row" style="margin:10px;">
                                                                                                                            <div class="col-md-12" hidden>
                                                                                                                                <SfNumericTextBox @bind-Value="@(AnswerReviewData.AptituddeTestQuestionAnswersId)" Enabled="false" Placeholder="Id" Format="N0" FloatLabelType="FloatLabelType.Always"></SfNumericTextBox>
                                                                                                                            </div>
                                                                                                                            <div class="col-md-12">
                                                                                                                                <p>Question</p>
                                                                                                                                <SfTextBox Multiline="true" @bind-Value="@(AnswerReviewData.Answer)" Enabled="true" Placeholder="Enter Question" FloatLabelType="FloatLabelType.Never"></SfTextBox>
                                                                                                                            </div>
                                                                                                                            <div class="col-md-4" style="padding-top:15px;">
                                                                                                                                <SfCheckBox @bind-Checked=@AnswerReviewData.IsCorrectAnswer Label="Is the Correct Answer?" LabelPosition="Syncfusion.Blazor.Buttons.LabelPosition.After" />
                                                                                                                            </div>
                                                                                                                        </div>
                                                                                            }
                                                                                        }
                                                                                    </Template>
                                                                                </GridEditSettings>
                                                                                <GridColumns>
                                                                                    @*<GridColumn Type="ColumnType.CheckBox" Width="50"></GridColumn>*@
                                                                                
                                                                                    <GridColumn Field=@nameof(AptituddeTestQuestionAnswers.AptituddeTestQuestionAnswersId) HeaderText="Id" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Left" IsPrimaryKey="true" IsIdentity="true" Visible="false" Width="100"></GridColumn>
                                                                                    <GridColumn Field=@nameof(AptituddeTestQuestionAnswers.Answer) HeaderText="Answer" Width="200" AllowFiltering="false"></GridColumn>
                                                                                    @*<GridColumn HeaderText="Rating" TextAlign="TextAlign.Center" Width="150">
                                                                                        <Template Context="RadioContext">
                                                                                            @{
                                                                                                var employee = (RadioContext as AptituddeTestQuestionAnswers);

                                                                                                <div class="col-md-12">
                                                                                                    <SfRadioButton Label="Yes" Name="options" Value=true TChecked="bool" @bind-Checked="@(employee.IsCorrectAnswer)" ValueChange="OnValueChange"></SfRadioButton>
                                                                                                    <SfRadioButton Label="No" Name="options" Value=false TChecked="bool" @bind-Checked="@(employee.IsCorrectAnswer)" ValueChange="OnValueChange"></SfRadioButton>
                                                                                                </div>
                                                                                            }
                                                                                        </Template>
                                                                                    </GridColumn>*@

                                                                                    <GridColumn Field=@nameof(AptituddeTestQuestionAnswers.IsCorrectAnswer) HeaderText="Correct Answer" Width="120" DisplayAsCheckBox="true" AllowEditing="true">

                                                                            <GridColumn HeaderText="Action"
                                                                                        TextAlign="TextAlign.Center"
                                                                                        Width="80"
                                                                                        CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr3" }})">
                                                                                <GridCommandColumns>
                                                                                    <GridCommandColumn Type="CommandButtonType.Delete" ButtonOption="@(new CommandButtonOptions() {IconCss = "e-icons e-delete", CssClass = "e-flat"})" ID="Delete"></GridCommandColumn>
                                                                                </GridCommandColumns>
                                                                            </GridColumn>

                                                                                    </GridColumn>
                                                                                    @*<GridColumn Field=@nameof(AptituddeTestQuestionAnswers.IsCorrectAnswer) HeaderText="Is Correct Answer" Width="120" AllowFiltering="false"></GridColumn>*@
                                                                                </GridColumns>
                                                                            </SfGrid>
                                                                            </div>
                                                                        </div>
                                                    }
                                                        }
                                                    </Template>
                                                </GridEditSettings>
                                                <GridColumns>
                                                    @*<GridColumn Type="ColumnType.CheckBox" Width="50"></GridColumn>*@
                                                    <GridColumn HeaderText="Action"
                                                                TextAlign="TextAlign.Center"
                                                                Width="50"
                                                                CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr3" }})">
                                                        <GridCommandColumns>
                                                            <GridCommandColumn Type="CommandButtonType.Edit" ButtonOption="@(new CommandButtonOptions() {IconCss = "e-icons e-edit", CssClass = "e-flat"})"></GridCommandColumn>
                                                        </GridCommandColumns>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(AptituddeTestQuestionModel.AptituddeTestQuestionId) HeaderText="Id" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Left" IsPrimaryKey="true" IsIdentity="true" Visible="false" Width="100"></GridColumn>
                                                    <GridColumn HeaderText="Question" Width="200" AllowFiltering="false">
                                                        <Template Context="QuestionContext">
                                                            @{
                                                        string? result = string.Empty;
                                                            var data = (QuestionContext as AptituddeTestQuestionModel)?.Aptituddetestquestions;
                                                            if(data != null){
                                                                result = data.Question;
                                                            }
                                                                        <p>@((MarkupString)@result)</p>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn HeaderText="Dificulty Level" Width="150" AllowFiltering="false">
                                                        <Template Context="QuestionContext">
                                                        @{
                                                    string? result = string.Empty;
                                                        var data = (QuestionContext as AptituddeTestQuestionModel)?.Aptituddetestquestions;
                                                    if(data != null){
                                                        if(DifficultyLevelData != null){
                                                                var _data = DifficultyLevelData.FirstOrDefault(o => o.DifficultyLevelId == data.DifficultyLevelId);
                                                            if(_data != null){
                                                                result = _data.DifficultyLevelDesc;
                                                            }
                                                        }
                                                    }
                                                                    <p>@result</p>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                    <GridColumn HeaderText="Score" Width="120" AllowFiltering="false">
                                                        <Template Context="QuestionContext">
                                                            @{
                                                        string? result = string.Empty;
                                                        var data = (QuestionContext as AptituddeTestQuestionModel)?.Aptituddetestquestions;
                                                        if (data != null)
                                                        {
                                                            result =$"{data.QuestionMark}";
                                                        }
                                                                        <p>@result</p>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn HeaderText="Allows Multiple answers" Width="120" AllowFiltering="false">
                                                        <Template Context="QuestionContext">
                                                            @{
                                                        string? result = string.Empty;
                                                        var data = (QuestionContext as AptituddeTestQuestionModel)?.Aptituddetestquestions;
                                                        if (data != null)
                                                        {
                                                            result = data.IsAmultiselectQuestion.ToString();
                                                        }
                                                                        <p>@result</p>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                </GridColumns>
                                            </SfGrid>
                                        </div>
                                    </div>
                        }
                    }
                </Template>
            </GridEditSettings>
            <GridColumns>
                @*<GridColumn Type="ColumnType.CheckBox" Width="50"></GridColumn>*@
                <GridColumn HeaderText="Action"
                            TextAlign="TextAlign.Center"
                            Width="50"
                            CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr3" }})">
                    <GridCommandColumns>
                        <GridCommandColumn Type="CommandButtonType.Edit" ButtonOption="@(new CommandButtonOptions() {IconCss = "e-icons e-edit", CssClass = "e-flat"})"></GridCommandColumn>
                    </GridCommandColumns>
                </GridColumn>
                <GridColumn Field=@nameof(AptituddeTestModel.AptituddeTestHeaderId) HeaderText="Id" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Left" IsPrimaryKey="true" IsIdentity="true" Visible="false" Width="100"></GridColumn>
                <GridForeignColumn Field=@nameof(AptituddeTestModel.DepartmentId) HeaderText="Department" Width="150" ForeignKeyField="@(nameof(ADepartment.DepartmentId))" ForeignKeyValue="@(nameof(ADepartment.DepartmentDescription))" ForeignDataSource="@DepartmentData"></GridForeignColumn>
                <GridForeignColumn Field=@nameof(AptituddeTestModel.JobTitleId) HeaderText="Job Title" Width="150" ForeignKeyField="@(nameof(AJobTitle.JobTitleId))" ForeignKeyValue="@(nameof(AJobTitle.JobTitleDescription))" ForeignDataSource="@JobTitleData"></GridForeignColumn>
                <GridColumn HeaderText="Test Duration" Width="150" AllowFiltering="false">
                    <Template>
                        @{
                            string? result = string.Empty;
                            var data = (context as AptituddeTestModel)?.Aptituddetestheader;
                            if(data != null){
                                if(DurationTypeData != null){
                                    var _duration = DurationTypeData.FirstOrDefault(o=> o.DurationTypeId== data.DurationTypeId);
                                    if(_duration != null){
                                        result = $"{data.TestDuration} {_duration.DurationTypeDesc}";
                                    }
                                }
                            }
                                    <p>@result</p>
                        }
                    </Template>
                </GridColumn>
                <GridColumn HeaderText="No of Question per session" Width="120" AllowFiltering="false">
                    <Template>
                        @{
                            string? result = string.Empty;
                            var data = (context as AptituddeTestModel)?.Aptituddetestheader;
                            if (data != null)
                            {
                                result = $"{data.NoOfQuestionsPerSession}";
                            }
                                    <p>@result</p>
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
        </SfGrid>
    </div>
    <div class="col-md-12">
    </div>
</div>




@*Confirm Deletion*@

<div class="form-group col-md-12">
    <SfDialog @ref="@ConfirmationDeleteDialogue" Width="400px" Target=".mainbody" ShowCloseIcon="false" Visible="false" IsModal="true">
        <DialogTemplates>
            <Content>
                @((MarkupString)@ConfirmationText)
            </Content>
        </DialogTemplates>
        <DialogButtons>
            <DialogButton Content="Yes" IsPrimary="true" OnClick="@ComfirmationApproveYes" />
            <DialogButton Content="No" OnClick="@ComfirmationApproveNo" />
        </DialogButtons>
    </SfDialog>
</div>
@*Saving Dialogue*@

@*Saving Dialogue*@
<div class="form-group col-md-12">
    <SfDialog Width="80%" Height="20vh" AllowDragging=true EnableResize=true
              CloseOnEscape=false IsModal=true ShowCloseIcon=false
              Target=".mainbody" @ref=@SavingDialog Visible=false>
        <DialogTemplates>
            <Content>
                <div class="dialogContent">
                    <div class="loader">
                        <div class="loader--dot"></div>
                        <div class="loader--dot"></div>
                        <div class="loader--dot"></div>
                        <div class="loader--dot"></div>
                        <div class="loader--dot"></div>
                        <div class="loader--dot"></div>
                        <div class="loader-Saving-text"></div>
                    </div>
                    @*<p>Saving Record please wait......</p>*@
                </div>
            </Content>
        </DialogTemplates>
    </SfDialog>
</div>



@code {
    #region Toasters
    public static string? ToastContent { get; set; }
    SfToast? ToastObj;
    SfToast? DeleteToastObj;
    private string ToastPosition = "Right";
    private int AlarmTimeout { get; set; } = 120000;
    private List<ToastModel> Toast = new List<ToastModel>
        {
            new ToastModel{ Title = "Warning!", Content=ToastContent, CssClass="e-toast-warning", Icon="e-warning toast-icons" },
            new ToastModel{ Title = "Success!", Content=ToastContent, CssClass="e-toast-success", Icon="e-success toast-icons" },
            new ToastModel{ Title = "Error!", Content=ToastContent, CssClass="e-toast-danger", Icon="e-error toast-icons" },
            new ToastModel{ Title = "Information!", Content=ToastContent, CssClass="e-toast-info", Icon="e-info toast-icons" }
        };
    #endregion Toasters
    private SfGrid<AptituddeTestModel>? AptituddeTestHeaderGrid;
    private SfGrid<AptituddeTestQuestionModel>? AptituddeTestQuestionGrid;
    private SfGrid<AptituddeTestQuestionAnswers>? AptituddeTestAnswerGrid;
    private AptituddeTestHeader? HeaderReviewData { get; set; }
    private AptituddeTestQuestions? QuestionReviewData { get; set; }
    private AptituddeTestQuestionAnswers? AnswerReviewData { get; set; }
    Query JobTitleChildQuery { get; set; } = new Query();

    private List<ADepartment>? DepartmentData { get; set; }
    private List<AJobTitle>? JobTitleData { get; set; }
    private List<ADurationType>? DurationTypeData{ get; set; }
    private List<ADifficultyLevel>? DifficultyLevelData { get; set; }
    private readonly JsonSerializerOptions _options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
    private DialogSettings DialogParams = new DialogSettings { Height = "auto", MinHeight = "80vh", Width = "96%" };
    SfSpinner UploadAttachmentSpinner;
    string? ImageString { get; set; }
    long maxFileSize = 5242880/* 1024L * 1024L * 1024L * 2L */;//5 Megabytes
    string fileName = string.Empty;
    SfRadioButton<bool> RadioButtonInstance;
    public bool radiovalue;
    SfDialog ConfirmationDeleteDialogue;
    string ConfirmationText { get; set; }
    AptituddeTestQuestionAnswers selectedemployee { get; set; }
    SfDialog SavingDialog { get; set; }
    int random = -9999;


    private ToolbarType Tooltype = ToolbarType.MultiRow;
    private List<ToolbarItemModel> Tools = new List<ToolbarItemModel>()
    {
        new ToolbarItemModel() { Command = ToolbarCommand.Bold },
        new ToolbarItemModel() { Command = ToolbarCommand.Italic },
        new ToolbarItemModel() { Command = ToolbarCommand.Underline },
        new ToolbarItemModel() { Command = ToolbarCommand.StrikeThrough },
        new ToolbarItemModel() { Command = ToolbarCommand.FontName },
        new ToolbarItemModel() { Command = ToolbarCommand.FontSize },
        new ToolbarItemModel() { Command = ToolbarCommand.FontColor },
        new ToolbarItemModel() { Command = ToolbarCommand.BackgroundColor },
        new ToolbarItemModel() { Command = ToolbarCommand.LowerCase },
        new ToolbarItemModel() { Command = ToolbarCommand.UpperCase },
        new ToolbarItemModel() { Command = ToolbarCommand.Separator },
        new ToolbarItemModel() { Command = ToolbarCommand.Formats },
        new ToolbarItemModel() { Command = ToolbarCommand.Alignments },
        new ToolbarItemModel() { Command = ToolbarCommand.OrderedList },
        new ToolbarItemModel() { Command = ToolbarCommand.UnorderedList },
        new ToolbarItemModel() { Command = ToolbarCommand.Outdent },
        new ToolbarItemModel() { Command = ToolbarCommand.Indent },
        new ToolbarItemModel() { Command = ToolbarCommand.Separator },
        new ToolbarItemModel() { Command = ToolbarCommand.CreateLink },
        //new ToolbarItemModel() { Command = ToolbarCommand.Image },
        new ToolbarItemModel() { Command = ToolbarCommand.Separator },
        new ToolbarItemModel() { Command = ToolbarCommand.ClearFormat },
        //new ToolbarItemModel() { Command = ToolbarCommand.Print },
        new ToolbarItemModel() { Command = ToolbarCommand.SourceCode },
        new ToolbarItemModel() { Command = ToolbarCommand.Separator },
        new ToolbarItemModel() { Command = ToolbarCommand.Undo },
        new ToolbarItemModel() { Command = ToolbarCommand.Redo }
    };
    private List<LinkToolbarItemModel> Link = new List<LinkToolbarItemModel>()
    {
        new LinkToolbarItemModel() { Command = LinkToolbarCommand.Open },
        new LinkToolbarItemModel() { Command = LinkToolbarCommand.Edit },
        new LinkToolbarItemModel() { Command = LinkToolbarCommand.UnLink }
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            string? accessToken = await settingsRepo.GetAccessToken();

            var tasks = new List<Task>();
            tasks.Add(Task.Run(async () =>
            {
                var response = await http.GetAsync($"Utilities/GetDepartment");
                var content = await response.Content.ReadAsStringAsync();
                if (response.IsSuccessStatusCode)
                {
                    DepartmentData = JsonSerializer.Deserialize<List<ADepartment>>(content, _options);
                }
            }));
            tasks.Add(Task.Run(async () =>
           {
               var response = await http.GetAsync($"Utilities/GetDurationType");
               var content = await response.Content.ReadAsStringAsync();
               if (response.IsSuccessStatusCode)
               {
                   DurationTypeData = JsonSerializer.Deserialize<List<ADurationType>>(content, _options);
               }
           }));
            tasks.Add(Task.Run(async () =>
            {
                var response = await http.GetAsync($"Utilities/GetDifficultyLevel");
                var content = await response.Content.ReadAsStringAsync();
                if (response.IsSuccessStatusCode)
                {
                    DifficultyLevelData = JsonSerializer.Deserialize<List<ADifficultyLevel>>(content, _options);
                }
            }));
            tasks.Add(Task.Run(async () =>
            {
                var response = await http.GetAsync($"HumanResource/GetJobTitle");
                var content = await response.Content.ReadAsStringAsync();
                if (response.IsSuccessStatusCode)
                {
                    JobTitleData = JsonSerializer.Deserialize<List<AJobTitle>>(content, _options);
                }
            }));
            Task t = Task.WhenAll(tasks);
            await t;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            //throw;
        }

        await base.OnInitializedAsync();
    }
    private void DepartmentValueChangeHandler(ChangeEventArgs<int?, ADepartment> args)
    {
        if (args.ItemData != null)
        {
            JobTitleChildQuery = new Query().Where(new WhereFilter() { Field = "DepartmentId", Operator = "equal", value = args.ItemData.DepartmentId, IgnoreCase = false, IgnoreAccent = false });
        }
    }

    public class AptituddeTestAdapter : DataAdaptor
    {
        private IToastService toastService;
        private IAptituddeTestReopsitory reopsitory;
        private readonly JsonSerializerOptions _options;
        public AptituddeTestAdapter(IToastService ts, IAptituddeTestReopsitory _reopsitory)
        {
            toastService = ts;
            reopsitory = _reopsitory;
            _options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        }
        public override async Task<Object> ReadAsync(DataManagerRequest dataManagerRequest, string key = null)
        {
            var data = new List<AptituddeTestModel>();
            try
            {
                data = await reopsitory.GetAllAptituddeTests();
            }
            catch (Exception ex)
            {
                toastService.ShowError(ex.Message.ToString());
            }

            IEnumerable GridData = data;
            int _count = data.Count;
            if (dataManagerRequest.Search != null && dataManagerRequest.Search.Count > 0)
            {
                // Searching
                GridData = DataOperations.PerformSearching(GridData, dataManagerRequest.Search);
            }
            if (dataManagerRequest.Where != null && dataManagerRequest.Where.Count > 0)
            {
                // Filtering
                GridData = DataOperations.PerformFiltering(GridData, dataManagerRequest.Where, dataManagerRequest.Where[0].Operator);
            }
            if (dataManagerRequest.Sorted?.Count > 0) // perform Sorting
            {
                GridData = DataOperations.PerformSorting(GridData, dataManagerRequest.Sorted);
            }
            if (dataManagerRequest.Skip != 0)
            {
                GridData = DataOperations.PerformSkip(GridData, dataManagerRequest.Skip); //Paging
            }
            if (dataManagerRequest.Take != 0)
            {
                GridData = DataOperations.PerformTake(GridData, dataManagerRequest.Take);
            }
            IDictionary<string, object> aggregates = new Dictionary<string, object>();
            if (dataManagerRequest.Aggregates != null) // Aggregation
            {
                aggregates = DataUtil.PerformAggregation(GridData, dataManagerRequest.Aggregates);
            }
            if (dataManagerRequest.Group != null && dataManagerRequest.Group.Any()) //Grouping
            {
                foreach (var group in dataManagerRequest.Group)
                {
                    GridData = DataUtil.Group<AptituddeTestModel>(GridData, group, dataManagerRequest.Aggregates, 0, dataManagerRequest.GroupByFormatter);
                }
            }
            return dataManagerRequest.RequiresCounts ? new DataResult() { Result = GridData, Count = _count, Aggregates = aggregates } : (object)GridData;
        }
        public override async Task<Object> InsertAsync(DataManager dataManager, object value, string key)
        {
            try
            {
                var val = (value as AptituddeTestModel);
                var result = await reopsitory.SaveAptituddeTest(val);
                if (result.IsSuccessStatusCode)
                {
                    var content = await result.Content.ReadAsStringAsync();
                    var data = JsonSerializer.Deserialize<Response>(content, _options);
                    if (data != null)
                    {
                        if (data.IsSuccess)
                        {
                            toastService.ShowSuccess(data.Message);
                        }
                        else
                        {
                            toastService.ShowError(data.Message);
                        }
                    }
                }
                else
                {
                    toastService.ShowError(result.ReasonPhrase);
                }
            }
            catch (Exception ex)
            {
                toastService.ShowError(ex.Message.ToString());
            }
            return value;
        }

        public override async Task<object> UpdateAsync(DataManager dataManager, object value, string keyField, string key)
        {
            try
            {
                var val = (value as AptituddeTestModel);
                var result = await reopsitory.SaveAptituddeTest(val);
                if (result.IsSuccessStatusCode)
                {
                    var content = await result.Content.ReadAsStringAsync();
                    var data = JsonSerializer.Deserialize<Response>(content, _options);
                    if (data != null)
                    {
                        if (data.IsSuccess)
                        {
                            toastService.ShowSuccess(data.Message);
                        }
                        else
                        {
                            toastService.ShowError(data.Message);
                        }
                    }
                }
                else
                {
                    toastService.ShowError(result.ReasonPhrase);
                }
            }
            catch (Exception ex)
            {
                toastService.ShowError(ex.Message.ToString());
            }

            return value;
        }

        // public override async Task<object> BatchUpdateAsync(DataManager dataManager, object changedRecords, object addedRecords, object deletedRecords, string primaryColumnName, string key, int? dropIndex)
        // {
        //     object ReturnValue = changedRecords;
        //     if (changedRecords != null)
        //     {
        //         ReturnValue = changedRecords;

        //         var val = (changedRecords as List<AptituddeTestModel>);
        //         if (val != null && val.Count > 0)
        //         {
        //             foreach (var item in val)
        //             {
        //                 var result = await reopsitory.SaveAptituddeTest(item);

        //                 if (result.IsSuccessStatusCode)
        //                 {
        //                     toastService.ShowSuccess("Record was sucessfully updated");
        //                 }
        //                 else
        //                 {
        //                     toastService.ShowError("Ooops. Something went wrong");
        //                 }
        //             }
        //         }
        //     }

        //     if (addedRecords != null)
        //     {
        //         ReturnValue = addedRecords;

        //         var val = (addedRecords as List<AptituddeTestModel>);
        //         if (val != null && val.Count > 0)
        //         {
        //             foreach (var item in val)
        //             {
        //                 var result = await reopsitory.SaveAptituddeTest(item);

        //                 if (result.IsSuccessStatusCode)
        //                 {
        //                     toastService.ShowSuccess("Record was sucessfully added");
        //                 }
        //                 else
        //                 {
        //                     toastService.ShowError("Ooops. Something went wrong");
        //                 }
        //             }
        //         }
        //     }

        //     return ReturnValue;
        // }

    }
    public async Task OnAptituddeTestActionComplete(ActionEventArgs<AptituddeTestModel> args)
    {
        try
        {
            if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add) || args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.BeginEdit))
            {
                AptituddeTestHeaderGrid?.PreventRender(false);

            }
        }
        catch (Exception ex)
        {
            await ToastObj.ShowAsync(new ToastModel { Title = "Error!", Content = ex.Message.ToString(), CssClass = "e-toast-danger", Icon = "e-error toast-icons" });
        }

    }
    public async Task OnAptituddeTestActionBegin(ActionEventArgs<AptituddeTestModel> args)
    {
        try
        {
            if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add))
            {
                args.RowData.Aptituddetestheader = new();
                args.RowData.Aptituddetestquestions = new();
            }
            else if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.BeginEdit))
            {
                JobTitleChildQuery = new Query().Where(new WhereFilter() { Field = "DepartmentId", Operator = "equal", value = args.RowData.DepartmentId, IgnoreCase = false, IgnoreAccent = false });
                if (args.RowData.Aptituddetestquestions==null){
                    args.RowData.Aptituddetestquestions = new();
                }
            }
            else if(args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Save))
            {
                if (args.Data.Aptituddetestheader.DepartmentId == null)
                {
                    toasterservice.ClearAll();
                    toasterservice.ShowWarning("Please select the department !");
                    args.Cancel = true;
                }
                else if (args.Data.Aptituddetestheader.JobTitleId == null)
                {
                    toasterservice.ClearAll();
                    toasterservice.ShowWarning("Please select the job title !");
                    args.Cancel = true;
                }
                else if (args.Data.Aptituddetestheader.PassMark == null)
                {
                    toasterservice.ClearAll();
                    toasterservice.ShowWarning("Please enter the pass mark !");
                    args.Cancel = true;
                }
                else if (string.IsNullOrEmpty(args.Data.Aptituddetestheader.TestSummary))
                {
                    toasterservice.ClearAll();
                    toasterservice.ShowWarning("Please enter the summary !");
                    args.Cancel = true;
                }
                else if (args.Data.Aptituddetestheader.TestDuration == null)
                {
                    toasterservice.ClearAll();
                    toasterservice.ShowWarning("Please enter the duration !");
                    args.Cancel = true;
                }
                else if (args.Data.Aptituddetestheader.DurationTypeId == null)
                {
                    toasterservice.ClearAll();
                    toasterservice.ShowWarning("Please enter the duration type!");
                    args.Cancel = true;
                }
                else if (args.Data.Aptituddetestheader.NoOfQuestionsPerSession == null)
                {
                    toasterservice.ClearAll();
                    toasterservice.ShowWarning("Please enter the no. of uestions per session!");
                    args.Cancel = true;
                }
                else if (args.Data.Aptituddetestquestions.Count == 0)
                {
                    toasterservice.ClearAll();
                    toasterservice.ShowWarning("Please set the aptitude questions!");
                    args.Cancel = true;
                }
            }
        }
        catch (Exception ex)
        {
            await ToastObj.ShowAsync(new ToastModel { Title = "Error!", Content = ex.Message.ToString(), CssClass = "e-toast-danger", Icon = "e-error toast-icons" });
        }

    }

    public async Task OnQuestionActionComplete(ActionEventArgs<AptituddeTestQuestionModel> args)
    {
        try
        {
            if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add) || args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.BeginEdit))
            {
                AptituddeTestQuestionGrid?.PreventRender(false);
                if(!string.IsNullOrEmpty(args.RowData.Aptituddetestquestions.QuestionImageName) && !string.IsNullOrEmpty(args.RowData.Aptituddetestquestions.QuestionImageExt))
                {
                    ImageString = await GetImageString(args.RowData.Aptituddetestquestions.QuestionImageName, args.RowData.Aptituddetestquestions.QuestionImageExt,"AptitudeQuestionImages");
                }
            }
        }
        catch (Exception ex)
        {
            await ToastObj.ShowAsync(new ToastModel { Title = "Error!", Content = ex.Message.ToString(), CssClass = "e-toast-danger", Icon = "e-error toast-icons" });
        }

    }
    public async Task OnQuestionActionBegin(ActionEventArgs<AptituddeTestQuestionModel> args)
    {
        try
        {
            if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add))
            {
                args.RowData.Aptituddetestquestions = new();
                args.RowData.Aptituddetestquestionanswers = new();
                Random random = new Random();
                int id = random.Next(-100, -1);
                args.RowData.Aptituddetestquestions.AptituddeTestQuestionId = id;
                args.RowData.AptituddeTestQuestionId = id;
            }
            else if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.BeginEdit))
            {
                if (args.RowData.Aptituddetestquestionanswers == null)
                {
                    args.RowData.Aptituddetestquestionanswers = new();
                }
            }
        }
        catch (Exception ex)
        {
            await ToastObj.ShowAsync(new ToastModel { Title = "Error!", Content = ex.Message.ToString(), CssClass = "e-toast-danger", Icon = "e-error toast-icons" });
        }

    }
    public async Task OnAnswerActionComplete(ActionEventArgs<AptituddeTestQuestionAnswers> args)
    {
        try
        {
            if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add) || args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.BeginEdit))
            {
                AptituddeTestAnswerGrid?.PreventRender(false);
            }
            else if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Save) || args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Refresh))
            {
                AptituddeTestAnswerGrid?.Refresh();
            }
        }
        catch (Exception ex)
        {
            await ToastObj.ShowAsync(new ToastModel { Title = "Error!", Content = ex.Message.ToString(), CssClass = "e-toast-danger", Icon = "e-error toast-icons" });
        }

    }
    public async Task OnAnswerActionBegin(ActionEventArgs<AptituddeTestQuestionAnswers> args)
    {
        try
        {
            if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add))
            {
                Random random = new Random();
                int id = random.Next(-100, -1);
                args.RowData.AptituddeTestQuestionAnswersId = id;
                args.RowData.AptituddeTestQuestionId = QuestionReviewData?.AptituddeTestQuestionId;
            }
            else if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.BeginEdit))
            {

            }
        }
        catch (Exception ex)
        {
            await ToastObj.ShowAsync(new ToastModel { Title = "Error!", Content = ex.Message.ToString(), CssClass = "e-toast-danger", Icon = "e-error toast-icons" });
        }

    }

    private async Task CellSavedHandler(CellSaveArgs<AptituddeTestQuestionAnswers> args)
    {
        try
        {
            await AptituddeTestAnswerGrid.EndEditAsync();
        }
        catch (Exception ex)
        {
            toasterservice.ShowError(ex.Message);
        }
        finally
        {

        }
    }

    //Enable cell edit on single click
    public async Task CellSelectHandler(CellSelectEventArgs<AptituddeTestQuestionAnswers> args)
    {
        try
        {
            //get selected cell index
            var CellIndexes = await AptituddeTestAnswerGrid.GetSelectedRowCellIndexesAsync();

            //get the row and cell index
            var CurrentEditRowIndex = CellIndexes[0].Item1;
            var CurrentEditCellIndex = (int)CellIndexes[0].Item2;

            //get the available fields
            var fields = await AptituddeTestAnswerGrid.GetColumnFieldNamesAsync();
            // edit the selected cell using the cell index and column name
            await AptituddeTestAnswerGrid.EditCellAsync(CurrentEditRowIndex, fields[CurrentEditCellIndex]);
        }
        catch (Exception ex)
        {
            // throw ex;
        }
    }

    public void BatchAddHandler(BeforeBatchAddArgs<AptituddeTestQuestionAnswers> Args)
    {
        Args.DefaultData.AptituddeTestQuestionAnswersId = random;
        random++;
    }

    public async Task OnCommandClicked(CommandClickEventArgs<AptituddeTestQuestionAnswers> args)
    {

        if (args.CommandColumn.ID == "Delete")
        {
            try
            {
                selectedemployee = args.RowData;
                ConfirmationText = "<p>Are you sure you want to delete this record? </p>";
                await this.ConfirmationDeleteDialogue.ShowAsync();
            }
            catch (Exception ex)
            {
                toasterservice.ShowError(ex.Message.ToString());
            }
            finally
            {
                StateHasChanged();
            }

        }
    }


    private async void ComfirmationApproveYes()
    {
        try
        {
            await this.ConfirmationDeleteDialogue.HideAsync();
                        
            string json = Newtonsoft.Json.JsonConvert.SerializeObject(selectedemployee);
            StringContent httpContent = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

            if(selectedemployee.AptituddeTestQuestionAnswersId != 0)
            {
                await SavingDialog.ShowAsync();
                var result = await http.PostAsync($"HumanResource/DeleteAptituddeTestAnswer?qualificationid={selectedemployee.AptituddeTestQuestionAnswersId}", httpContent);

                if (result.IsSuccessStatusCode)
                {
                    try
                    {
                        if (AptituddeTestAnswerGrid != null)
                        {
                            await AptituddeTestAnswerGrid.Refresh();
                        }
                        toasterservice.ClearAll();
                        toasterservice.ShowSuccess("Record Successfully Deleted");
                    }
                    catch (Exception ex)
                    {
                        throw ex;
                    }
                    finally
                    {
                        await SavingDialog.HideAsync();
                    }

                }
                else
                {
                    toasterservice.ClearAll();
                    toasterservice.ShowWarning("Record cannot be deleted because it is arleady used else where in the system");
                }
            }

            else
            {
                toasterservice.ClearAll();
                toasterservice.ShowWarning("This record is not yet saved in the database. There is nothing to be deleted.");
            }
        }
        catch (Exception ex)
        {
            toasterservice.ShowError(ex.Message.ToString());
        }
        finally
        {
            await SavingDialog.HideAsync();
            StateHasChanged();
        }
    }

    private void ComfirmationApproveNo()
    {
        this.ConfirmationDeleteDialogue.HideAsync();
    }

    private void OnValueChange(ChangeArgs<bool> args)
    {
        radiovalue = args.Value;
    }

    private async Task SingleUpload(InputFileChangeEventArgs e)
    {
        try
        {
            //IsSaveDisabled = true;
            await UploadAttachmentSpinner.ShowAsync();
            MemoryStream ms = new MemoryStream();
            await e.File.OpenReadStream(maxFileSize).CopyToAsync(ms);

            ms.Position = 0;
            System.IO.FileInfo info = new System.IO.FileInfo(e.File.Name);
            if (info.Extension.ToLower().Contains("png") || info.Extension.ToLower().Contains("gif") || info.Extension.ToLower().Contains("jpeg") || info.Extension.ToLower().Contains("jpg"))
            {
                fileName = "AptitudeQuestionImages_" + DateTime.Now.ToString("dd-MM-yyyy HH-mm-ss") + info.Extension;
                
                byte[] bytes = ms.ToArray();
                //byte[] bytes = file.Stream.ToArray();
                string base64 = Convert.ToBase64String(bytes, 0, bytes.Length);
                DocumentBytes m = new DocumentBytes()
                    {
                        DocumentName = fileName,
                        DocumentExt = info.Extension.Trim(),
                        DocumentByte = bytes,
                        DocumentFolder = "AptitudeQuestionImages"
                    };

                await _DocumentUploadModel.UploadDocument(m);
                var result = "data:application/pdf;base64," + base64;
                QuestionReviewData.QuestionImageName = fileName;
                QuestionReviewData.QuestionImageExt = info.Extension.Trim();
                ImageString = result;
                bytes = null;

            }

            else
            {
                toasterservice.ShowWarning("Please ensure that the uploaded document is an image(png/Jpeg/gif/jpg).");
            }
        }
        catch (Exception ex)

        {
            throw ex;
        }

        finally
        {
            ///IsSaveDisabled = false;
            await UploadAttachmentSpinner.HideAsync();
            StateHasChanged();
        }

    }

    private async Task<string> GetImageString(string imageUrl, string ext, string DocumentFolder)
    {
        string result = null;
        try
        {
            if (!string.IsNullOrEmpty(imageUrl))
            {
                var a = await _DocumentUploadModel.GetDocument(imageUrl, DocumentFolder);

                if (a != null && !string.IsNullOrEmpty(a.DocumentExt) && a.DocumentByte != null && a.DocumentByte.Length > 0)
                {
                    if (a.DocumentExt.Contains("pdf"))
                    {
                        string base64String = Convert.ToBase64String(a.DocumentByte, 0, a.DocumentByte.Length);
                        result = "data:application/pdf;base64," + base64String;
                    }
                    else
                    {
                        string base64String = Convert.ToBase64String(a.DocumentByte, 0, a.DocumentByte.Length);
                        result = "data:image/" + a.DocumentExt.Replace(".","").Trim() + ";base64," + base64String;
                    }

                }
            }
        }
        catch (Exception ex)
        {
            toasterservice.ShowError(ex.Message.ToString());
        }
        return result;
    }
}
