@page "/JobDescriptionPage"

@using HCMIS.Data
@using HCMIS.Interface
@using HCMIS.Model
@using System.Text.Json
@using HCMIS.SHARED.Data;
@using HCMIS.SHARED.Models;
@using HCMIS.ViewModel
@using System.Collections;
@inject HttpClient Http
@inject AppState AppState
@inject ApiConfig _ApiConfig;
@inject NavigationManager navManager
@inject DocumentUploadModel _DocumentUploadModel;
@inject IToastService toastService;
@inject IJSRuntime JSRuntime;
@inject IAuthenticationService AuthService;

<style>

    p {
        margin-top: 0;
        margin-bottom: 1rem;
        font-size: medium;
        font-weight: bold;
    }

</style>

<ol class="breadcrumb" style="margin-top:5px;">
    <li class="breadcrumb-item active" style="color: brown;">
        <strong>
            <img src="/Image/logonhcc.png" width="40" height="25" /> HCMIS
        </strong>| JOB DESCRIPTION DETAILS
    </li>
</ol>

<SfGrid @ref="@JobDescriptionGrid" TValue="JobDescription" ID="Grid1" AllowPaging="true" AllowFiltering="true" AllowReordering="true" AllowResizing="true" AllowGrouping="false" AllowExcelExport="true" AllowPdfExport="true" AllowSelection="true" AllowSorting="true" Toolbar="@(new List<string>() {"Add", "Cancel", "Update","ExcelExport","PdfExport","CsvExport", "Search"})">
    <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
    <GridPageSettings PageSizes="true"></GridPageSettings>
        <GridSelectionSettings Type="Syncfusion.Blazor.Grids.SelectionType.Single"></GridSelectionSettings>
    <GridEvents OnToolbarClick="@GridToolbarClick" TValue="JobDescription"></GridEvents>
    <SfDataManager AdaptorInstance="@typeof(JobDescriptionAdapter)" Adaptor="Adaptors.CustomAdaptor"></SfDataManager>
    <GridEvents OnActionComplete="@OnJobDescriptionActionComplete" OnActionBegin="@OnJobDescriptionActionBegin" TValue="JobDescription"></GridEvents>
    <GridEditSettings AllowAdding="true" AllowDeleting="false" AllowEditing="true" Mode="@EditMode.Dialog" Dialog="DialogParams">
        <HeaderTemplate>
            @{
                var text = GetJobDescriptionHeader((context as JobDescription));
                                <div class="headerbandimg">
                            <span>@text</span>
                                </div>
            }
        </HeaderTemplate>
        <Template Context="JobDescriptionContext">
            @{
                JobDescriptionReviewData = (JobDescriptionContext as JobDescription);
                if(JobDescriptionReviewData != null){
                            <SfTab HeaderPlacement="HeaderPosition.Top" LoadOn="ContentLoad.Demand" OverflowMode="@OverflowMode.Scrollable" >
                                <TabItems>
                                    <TabItem>
                                        <ChildContent>
                                            <TabHeader Text="Job Description"></TabHeader> 
                                        </ChildContent>
                                        <ContentTemplate>
                                            <div style="margin:10px;">
                                                <div class="row">
                                                    <div class="col-md-12" hidden>
                                                        <SfNumericTextBox @ref="@JobDescriptionIdTxt" @bind-Value="@(JobDescriptionReviewData.JobDescriptionId)" ID="JobDescriptionId" TValue="int" Width="100%" Format="N0" Placeholder="Job Description Id" Step="1" FloatLabelType="FloatLabelType.Never"></SfNumericTextBox>
                                                    </div>                                                    

                                                    <div class="col-md-6">
                                                         <p>Job Title<span style="color:red;">*</span></p>
                                                          @*Query="@(JobTitleChildQuery)" *@
                                                        <SfDropDownList @ref="JobTitleObj" @bind-Value="@(JobDescriptionReviewData.JibTitleId)"TItem="AJobTitle" TValue="int?" Width="100%" PopupHeight="230px" AllowFiltering=true IgnoreAccent=true DataSource="@JobTitleData"  Placeholder="Please Select" @onclick="@((args) => OnClick(JobTitleObj.ID))">
                                                            <DropDownListFieldSettings Value="JobTitleId" Text="@(nameof(AJobTitle.JobTitleDescription))"></DropDownListFieldSettings>
                                                            <DropDownListEvents TItem="AJobTitle" TValue="int?" ValueChange="@JobTitleValueChangeHandler" OnOpen="@((e)=>OnOpenHandler(JobTitleObj.ID))" ></DropDownListEvents>
                                                        </SfDropDownList>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <p>Department<span style="color:red;">*</span></p>
                                                        <SfDropDownList @bind-Value="@(JobDescriptionReviewData.DepartmentId)" TItem="ADepartment" Enabled="false" TValue="int?" Width="100%" PopupHeight="230px" AllowFiltering=true IgnoreAccent=true DataSource="@DepartmentData"  Placeholder="Please Select">
                                                            <DropDownListFieldSettings Text="DepartmentDescription" Value="DepartmentId"></DropDownListFieldSettings>
                                                            @*<DropDownListEvents TItem="ADepartment" TValue="int?" ValueChange="@DepartmentValueChangeHandler" ></DropDownListEvents>*@
                                                        </SfDropDownList>
                                                    </div>

                                                    <div class="col-md-6">

                                                        <p>Job Type<span style="color:red;">*</span></p>
                                                        <SfDropDownList @bind-Value="@(JobDescriptionReviewData.JobTypeId)" TItem="AJobType" TValue="int?" Width="100%" PopupHeight="230px" DataSource="@JobTypeData"  Placeholder="Please Select">
                                                            <DropDownListFieldSettings Text="TypeDescription" Value="JobTypeId"></DropDownListFieldSettings>
                                                        </SfDropDownList>
                                                    </div>


                                                     <div class="col-md-6">
                                                         <p>Salary Scale</p>
                                                        <SfDropDownList @bind-Value="@(JobDescriptionReviewData.SalaryScaleId)" TItem="ASalaryScale" TValue="int?" Width="100%" PopupHeight="230px" DataSource="@SalaryScaleData"  Placeholder="Please Select">
                                                            <DropDownListFieldSettings Text="SalaryScaleDescription" Value="SalaryScaleId"></DropDownListFieldSettings>
                                                        </SfDropDownList>
                                                     </div>                                                    

                                                    <div class="col-md-6">
                                                        <p>Minimum Level of Education<span style="color:red;">*</span></p>
                                                        <SfDropDownList @bind-Value="@(JobDescriptionReviewData.MinimumLevelOfEducationId)" TItem="ALevelofEducation" TValue="int?" Width="100%" PopupHeight="230px" DataSource="@LevelofEducationData" Placeholder="Please Select">
                                                            <DropDownListFieldSettings Text="LevelofEducationDesc" Value="LevelofEducationId"></DropDownListFieldSettings>
                                                        </SfDropDownList>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <p>Minimum Years of Experience<span style="color:red;">*</span></p>
                                                        <SfDropDownList @bind-Value="@(JobDescriptionReviewData.MinimumYearsofExperience)" TItem="AYearsofExperience" TValue="double?" Width="100%" PopupHeight="230px" DataSource="@YearsofExperienceData" Placeholder="Please Select">
                                                            <DropDownListFieldSettings Text="YearsofExperienceDesc" Value="YearsofExperienceId"></DropDownListFieldSettings>
                                                        </SfDropDownList>
                                                    </div> 

                                                    <div class="col-md-6">
                                                        <p>No of Vacancies<span style="color:red;">*</span></p>
                                                        <SfNumericTextBox @bind-Value="@(JobDescriptionReviewData.Vacancies)" TValue="int?" Width="100%" Format="N0" Placeholder="Enter Number" Step="1" FloatLabelType="FloatLabelType.Never"></SfNumericTextBox>
                                                    </div>  

                                                    <div class="col-md-12">
                                                        <h6 style="background-color:#268cff; color:ghostwhite;font-weight:bolder;font-size:large; text-align:center;margin-top: 10px;height: 30px;vertical-align: middle;">Qualifications<span style="color:red;">*</span></h6>

                                                        <SfTextBox Multiline=true rows="6" @bind-Value="@(JobDescriptionReviewData.Qualification)" Placeholder="Type Here ...." Width="100%" FloatLabelType="FloatLabelType.Never"></SfTextBox>
                                                    </div>

                                                    <div class="col-md-12">
                                                        @*<p>Experience<span style="color:red;">*</span></p>*@
                                                        <h6 style="background-color:#268cff; color:ghostwhite;font-weight:bolder;font-size:large; text-align:center;margin-top: 10px;height: 30px;vertical-align: middle;">Experience<span style="color:red;">*</span></h6>

                                                        <SfTextBox Multiline=true rows="6" @bind-Value="@(JobDescriptionReviewData.RequiredWorkExperience)" Placeholder="Type Here ...." Width="100%" FloatLabelType="FloatLabelType.Never"></SfTextBox>
                                                    </div>
                                                            

                                                    <div class="col-md-12">
                                                        @*<p>Other Requirements</p>*@
                                                        <h6 style="background-color:#268cff; color:ghostwhite;font-weight:bolder;font-size:large; text-align:center;margin-top: 10px;height: 30px;vertical-align: middle;">Other Requirements<span style="color:red;">*</span></h6>

                                                         <SfTextBox Multiline=true rows="6" @bind-Value="@(JobDescriptionReviewData.OtherRequirements)" Placeholder="Type Here ...." Width="100%" FloatLabelType="FloatLabelType.Never"></SfTextBox>
                                                    </div>  

                                                    <div class="col-md-12">
                                                        @*<p>Duties and Responsibilities<span style="color:red;">*</span></p>*@
                                                        <h6 style="background-color:#268cff; color:ghostwhite;font-weight:bolder;font-size:large; text-align:center;margin-top: 10px;height: 30px;vertical-align: middle;">Duties and Responsibilities<span style="color:red;">*</span></h6>

                                                        <SfRichTextEditor Height="400px" ShowCharCount="true" @bind-Value="@(JobDescriptionReviewData.JobDescription1)" Placeholder="Type something..." EnableResize=true EditorMode="EditorMode.HTML">
                                                            <RichTextEditorQuickToolbarSettings Link="@Link" />
                                                            <RichTextEditorToolbarSettings Type="@Tooltype" Items="@Tools" Enable=true EnableFloating="true" />
                                                        </SfRichTextEditor>
                                                    </div>  

                                                </div>
                                            </div>
                                        </ContentTemplate>
                                    </TabItem>
                            </TabItems>
                            </SfTab>
                }
            }
        </Template>
    </GridEditSettings>
    <GridColumns>
        <GridColumn HeaderText="Manage"
                    Width="40"
                    TextAlign="Syncfusion.Blazor.Grids.TextAlign.Left">
            <GridCommandColumns>
                <GridCommandColumn Type="CommandButtonType.Edit" ButtonOption="@(new CommandButtonOptions() { CssClass="e-icons e-view-details",Content="Edit" })" Title="Edit/View"></GridCommandColumn>
            </GridCommandColumns>
        </GridColumn>
      @*<GridColumn Type="ColumnType.CheckBox" Width="50"></GridColumn>*@
    	<GridColumn Field=@nameof(JobDescription.JobDescriptionId) Visible=false HeaderText="JobDescriptionId" AllowEditing="false" IsPrimaryKey="true" Width="150"></GridColumn>
        <GridForeignColumn Field=@nameof(JobDescription.JibTitleId) HeaderText="Job Title"  Width="150" ForeignKeyField="@(nameof(AJobTitle.JobTitleId))" ForeignKeyValue="@(nameof(AJobTitle.JobTitleDescription))" ForeignDataSource="@JobTitleData"></GridForeignColumn>
        <GridForeignColumn Field=@nameof(JobDescription.DepartmentId) HeaderText="Department" Width="150" ForeignKeyField="@(nameof(ADepartment.DepartmentId))" ForeignKeyValue="@(nameof(ADepartment.DepartmentDescription))" ForeignDataSource="@DepartmentData"></GridForeignColumn>
        <GridForeignColumn Field=@nameof(JobDescription.SalaryScaleId) HeaderText="Salary Scale" Width="150" ForeignKeyField="@(nameof(ASalaryScale.SalaryScaleId))" ForeignKeyValue="@(nameof(ASalaryScale.SalaryScaleDescription))" ForeignDataSource="@SalaryScaleData"></GridForeignColumn>
        <GridColumn Field=@nameof(JobDescription.JobDescription1) Visible=false HeaderText="Job Description"  Width="150">
            <Template>
                @{
                    <p>@((MarkupString)(context as JobDescription)?.JobDescription1)</p>
                }
            </Template>
        </GridColumn>
        <GridForeignColumn Field=@nameof(JobDescription.JobTypeId) HeaderText="Job Type" Width="150" ForeignKeyField="@(nameof(AJobType.JobTypeId))" ForeignKeyValue="@(nameof(AJobType.TypeDescription))" ForeignDataSource="@JobTypeData"></GridForeignColumn>
        <GridColumn Field=@nameof(JobDescription.Vacancies) HeaderText="Vacancies"  Width="150"></GridColumn>
        <GridForeignColumn Field=@nameof(JobDescription.JobStatusId) HeaderText="Job Status" Width="150" ForeignKeyField="@(nameof(AJobStatus.JobStatusId))" ForeignKeyValue="@(nameof(AJobStatus.JobStatusDesc))" ForeignDataSource="@JobStatusData"></GridForeignColumn>
    </GridColumns>
</SfGrid>


@*Saving Dialogue*@
<div class="form-group col-md-12">
    <SfDialog Width="80%" Height="20vh" AllowDragging=true EnableResize=true
              CloseOnEscape=false IsModal=true ShowCloseIcon=false
              Target=".mainbody" @ref=@SavingDialog Visible=false>
        <DialogTemplates>
            <Content>
                <div class="dialogContent">
                    <div class="loader">
                        <div class="loader--dot"></div>
                        <div class="loader--dot"></div>
                        <div class="loader--dot"></div>
                        <div class="loader--dot"></div>
                        <div class="loader--dot"></div>
                        <div class="loader--dot"></div>
                        <div class="loader-Saving-text"></div>
                    </div>
                    @*<p>Saving Record please wait......</p>*@
                </div>
            </Content>
        </DialogTemplates>
    </SfDialog>
</div>

@code {

    #region Toasters
    public static string? ToastContent { get; set; }
    SfToast? ToastObj;
    SfToast? DeleteToastObj;
    private string ToastPosition = "Right";
    private int AlarmTimeout { get; set; } = 120000;
    private List<ToastModel> Toast = new List<ToastModel>
        {
            new ToastModel{ Title = "Warning!", Content=ToastContent, CssClass="e-toast-warning", Icon="e-warning toast-icons" },
            new ToastModel{ Title = "Success!", Content=ToastContent, CssClass="e-toast-success", Icon="e-success toast-icons" },
            new ToastModel{ Title = "Error!", Content=ToastContent, CssClass="e-toast-danger", Icon="e-error toast-icons" },
            new ToastModel{ Title = "Information!", Content=ToastContent, CssClass="e-toast-info", Icon="e-info toast-icons" }
        };
    #endregion Toasters
    SfGrid<JobDescription>? JobDescriptionGrid { get; set; }
    SfGrid<JobDescriptionKnowledge>? JobDescriptionKnowledgeGrid { get; set; }
    SfGrid<JobDescriptionResponsibility>? JobDescriptionResponsibilityDataGrid { get; set; }
    SfGrid<JobDescriptionWorkExperienceRequirement>? JobDescriptionWorkExperienceRequirementGrid { get; set; }
    SfGrid<JobDescriptionBenefit>? JobDescriptionBenefitGrid { get; set; }
    JobDescription? JobDescriptionReviewData { get; set; }
    SfNumericTextBox<int>? JobDescriptionIdTxt { get; set; }
    String? JobDescriptionUrl { get; set; }
    List<AJobTitle>? JobTitleData { get; set; }
    List<ADepartment>? DepartmentData { get; set; }
    List<ASalaryScale>? SalaryScaleData { get; set; }
    List<AJobType>? JobTypeData { get; set; }
    List<AContractLengthType>? ContractLengthTypeData { get; set; }
    List<ALevelofEducation>? LevelofEducationData { get; set; }
    List<AJobStatus>? JobStatusData { get; set; }
    List<AFieldOfStudy>? FieldOfStudyData { get; set; }
    List<AYearsofExperience>? YearsofExperienceData { get; set; }
    string? ErrorMessage { get; set; } = null;
    Query ChildQuery { get; set; } = new Query();
    Query JobTitleChildQuery { get; set; } = new Query();
    SfDropDownList<int?, AJobTitle> JobTitleObj { get; set; }
    SfDialog SavingDialog { get; set; }
    LoginResultModel? Credentials { get; set; }

    private ToolbarType Tooltype = ToolbarType.MultiRow;
    private List<ToolbarItemModel> Tools = new List<ToolbarItemModel>()
    {
        new ToolbarItemModel() { Command = ToolbarCommand.Bold },
        new ToolbarItemModel() { Command = ToolbarCommand.Italic },
        new ToolbarItemModel() { Command = ToolbarCommand.Underline },
        new ToolbarItemModel() { Command = ToolbarCommand.StrikeThrough },
        new ToolbarItemModel() { Command = ToolbarCommand.FontName },
        new ToolbarItemModel() { Command = ToolbarCommand.FontSize },
        new ToolbarItemModel() { Command = ToolbarCommand.FontColor },
        new ToolbarItemModel() { Command = ToolbarCommand.BackgroundColor },
        new ToolbarItemModel() { Command = ToolbarCommand.LowerCase },
        new ToolbarItemModel() { Command = ToolbarCommand.UpperCase },
        new ToolbarItemModel() { Command = ToolbarCommand.Separator },
        new ToolbarItemModel() { Command = ToolbarCommand.Formats },
        new ToolbarItemModel() { Command = ToolbarCommand.Alignments },
        new ToolbarItemModel() { Command = ToolbarCommand.OrderedList },
        new ToolbarItemModel() { Command = ToolbarCommand.UnorderedList },
        new ToolbarItemModel() { Command = ToolbarCommand.Outdent },
        new ToolbarItemModel() { Command = ToolbarCommand.Indent },
        new ToolbarItemModel() { Command = ToolbarCommand.Separator },
        new ToolbarItemModel() { Command = ToolbarCommand.CreateLink },
        new ToolbarItemModel() { Command = ToolbarCommand.Image },
        new ToolbarItemModel() { Command = ToolbarCommand.Separator },
        new ToolbarItemModel() { Command = ToolbarCommand.ClearFormat },
        new ToolbarItemModel() { Command = ToolbarCommand.Print },
        new ToolbarItemModel() { Command = ToolbarCommand.SourceCode },
        new ToolbarItemModel() { Command = ToolbarCommand.Separator },
        new ToolbarItemModel() { Command = ToolbarCommand.Undo },
        new ToolbarItemModel() { Command = ToolbarCommand.Redo }
    };
    private List<LinkToolbarItemModel> Link = new List<LinkToolbarItemModel>()
    {
        new LinkToolbarItemModel() { Command = LinkToolbarCommand.Open },
        new LinkToolbarItemModel() { Command = LinkToolbarCommand.Edit },
        new LinkToolbarItemModel() { Command = LinkToolbarCommand.UnLink }
    };

    private void DepartmentValueChangeHandler(ChangeEventArgs<int?, ADepartment> args)
    {
        if(args.ItemData != null){
            JobTitleChildQuery= new Query().Where(new WhereFilter() { Field = "DepartmentId", Operator = "equal", value = args.ItemData.DepartmentId, IgnoreCase = false, IgnoreAccent = false });
        }
    }

    private void JobTitleValueChangeHandler(ChangeEventArgs<int?, AJobTitle> args)
    {
        if(args.ItemData != null)
        {
            JobDescriptionReviewData.DepartmentId = args.ItemData.DepartmentId;
        }
    }

    public async void OnClick(string clickedid)
    {
        await JSRuntime.InvokeVoidAsync("RequiredFieldClearFunction", clickedid);
        //Console.WriteLine(clickedid);
    }

    private async void OnOpenHandler(string clickedid)
    {
        await JSRuntime.InvokeVoidAsync("RequiredFieldClearFunction", clickedid);
    }

    /// <summary>
    /// Event for Toolbar click for Grid Exporting
    /// </summary>
    public void GridToolbarClick(Syncfusion.Blazor.Navigations.ClickEventArgs args)
    {
        if (args.Item.Id == "Grid1_excelexport")
        {
            this.JobDescriptionGrid.ExportToExcelAsync();
        }
        if (args.Item.Id == "Grid1_pdfexport")
        {
            this.JobDescriptionGrid.ExportToPdfAsync();
        }
        if (args.Item.Id == "Grid1_csvexport")
        {
            this.JobDescriptionGrid.ExportToCsvAsync();
        }
        if (args.Item.Id == "Grid2_excelexport")
        {
            this.JobDescriptionKnowledgeGrid.ExportToExcelAsync();
        }
        if (args.Item.Id == "Grid2_pdfexport")
        {
            this.JobDescriptionKnowledgeGrid.ExportToPdfAsync();
        }
        if (args.Item.Id == "Grid2_csvexport")
        {
            this.JobDescriptionKnowledgeGrid.ExportToCsvAsync();
        }
        if (args.Item.Id == "Grid3_excelexport")
        {
            this.JobDescriptionResponsibilityDataGrid.ExportToExcelAsync();
        }
        if (args.Item.Id == "Grid3_pdfexport")
        {
            this.JobDescriptionResponsibilityDataGrid.ExportToPdfAsync();
        }
        if (args.Item.Id == "Grid3_csvexport")
        {
            this.JobDescriptionResponsibilityDataGrid.ExportToCsvAsync();
        }
        if (args.Item.Id == "Grid4_excelexport")
        {
            this.JobDescriptionWorkExperienceRequirementGrid.ExportToExcelAsync();
        }
        if (args.Item.Id == "Grid4_pdfexport")
        {
            this.JobDescriptionWorkExperienceRequirementGrid.ExportToPdfAsync();
        }
        if (args.Item.Id == "Grid4_csvexport")
        {
            this.JobDescriptionWorkExperienceRequirementGrid.ExportToCsvAsync();
        }
        if (args.Item.Id == "Grid5_excelexport")
        {
            this.JobDescriptionBenefitGrid.ExportToExcelAsync();
        }
        if (args.Item.Id == "Grid5_pdfexport")
        {
            this.JobDescriptionBenefitGrid.ExportToPdfAsync();
        }
        if (args.Item.Id == "Grid5_csvexport")
        {
            this.JobDescriptionBenefitGrid.ExportToCsvAsync();
        }
    }
    private DialogSettings DialogParams = new DialogSettings { Height = "auto", MinHeight = "60vh", Width = "96%" };
    private readonly JsonSerializerOptions _options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
    protected override async Task OnInitializedAsync()
    {
        try
        {
            await base.OnInitializedAsync();
            var isAuthenticated = await AuthService.CheckAuthenticationStatus();
            if (isAuthenticated == false)
            {
                navManager.NavigateTo("/LoginPage", true);
            }
            else
            {
                Credentials = await AuthService.GetUserCredentials();

                var tasks = new List<Task>();
                tasks.Add(Task.Run(async () =>
               {

                   var response = await Http.GetAsync($"HumanResource/GetJobTitle");
                   var content = await response.Content.ReadAsStringAsync();
                   if (response.IsSuccessStatusCode)
                   {
                       JobTitleData = JsonSerializer.Deserialize<List<AJobTitle>>(content, _options);
                   }
               }));
                tasks.Add(Task.Run(async () =>
               {

                   var response = await Http.GetAsync($"Utilities/GetDepartment");
                   var content = await response.Content.ReadAsStringAsync();
                   if (response.IsSuccessStatusCode)
                   {
                       DepartmentData = JsonSerializer.Deserialize<List<ADepartment>>(content, _options);
                   }
               }));
                tasks.Add(Task.Run(async () =>
                {

                    var response = await Http.GetAsync($"Utilities/GetSalaryScale");
                    var content = await response.Content.ReadAsStringAsync();
                    if (response.IsSuccessStatusCode)
                    {
                        SalaryScaleData = JsonSerializer.Deserialize<List<ASalaryScale>>(content, _options);
                    }
                }));
                tasks.Add(Task.Run(async () =>
                {

                    var response = await Http.GetAsync($"Utilities/GetJobType");
                    var content = await response.Content.ReadAsStringAsync();
                    if (response.IsSuccessStatusCode)
                    {
                        JobTypeData = JsonSerializer.Deserialize<List<AJobType>>(content, _options);
                    }
                }));
                tasks.Add(Task.Run(async () =>
                {

                    var response = await Http.GetAsync($"Utilities/GetContractLengthType");
                    var content = await response.Content.ReadAsStringAsync();
                    if (response.IsSuccessStatusCode)
                    {
                        ContractLengthTypeData = JsonSerializer.Deserialize<List<AContractLengthType>>(content, _options);
                    }
                }));
                tasks.Add(Task.Run(async () =>
                {

                    var response = await Http.GetAsync($"Utilities/GetLevelofEducation");
                    var content = await response.Content.ReadAsStringAsync();
                    if (response.IsSuccessStatusCode)
                    {
                        LevelofEducationData = JsonSerializer.Deserialize<List<ALevelofEducation>>(content, _options);
                    }
                }));

                tasks.Add(Task.Run(async () =>
                {

                    var response = await Http.GetAsync($"Utilities/GetFieldOfStudy");
                    var content = await response.Content.ReadAsStringAsync();
                    if (response.IsSuccessStatusCode)
                    {
                        FieldOfStudyData = JsonSerializer.Deserialize<List<AFieldOfStudy>>(content, _options);
                    }
                }));

                tasks.Add(Task.Run(async () =>
               {

                   var response = await Http.GetAsync($"Utilities/GetYearsofExperience");
                   var content = await response.Content.ReadAsStringAsync();
                   if (response.IsSuccessStatusCode)
                   {
                       YearsofExperienceData = JsonSerializer.Deserialize<List<AYearsofExperience>>(content, _options);
                   }
               }));


                Task t = Task.WhenAll(tasks);
                await t;
            }
            
        }
        catch(Exception ex)
        {
            ErrorMessage=$"Error: {ex.Message}";
        }
        await base.OnInitializedAsync();
        StateHasChanged();
    }


    public class JobDescriptionAdapter : DataAdaptor
    {
        HttpClient Http;
        private readonly JsonSerializerOptions _options;
        SystemSettings _SystemSettings;
        ApiConfig _ApiConfig;
        public IToastService toastService;
        //private UserManagement _userManagement;
        public JobDescriptionAdapter(HttpClient _http, IToastService ts/*, UserManagement userManagement*/
        ,SystemSettings systemSettings,ApiConfig apiConfig)
        {
            Http = _http;
            _options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            _SystemSettings = systemSettings;
            _ApiConfig = apiConfig;
            //_userManagement = userManagement;
            toastService = ts;
        }

        public override async Task<Object> ReadAsync(DataManagerRequest dataManagerRequest, string key = null)
        {
            var data = new List<JobDescription>();
            try
            {
                var response = await Http.GetAsync($"HumanResource/GetJobDescription");
                var content = await response.Content.ReadAsStringAsync();
                if (response.IsSuccessStatusCode)
                {
                    data = JsonSerializer.Deserialize<List<JobDescription>>(content, _options);
                }

            }
            catch (Exception ex)
            {
                toastService.ShowError(ex.Message.ToString());
            }

            IEnumerable GridData = data;
            int _count = data.Count;
            if (dataManagerRequest.Search != null && dataManagerRequest.Search.Count > 0)
            {
                // Searching
                GridData = DataOperations.PerformSearching(GridData, dataManagerRequest.Search);
            }
            if (dataManagerRequest.Where != null && dataManagerRequest.Where.Count > 0)
            {
                // Filtering
                GridData = DataOperations.PerformFiltering(GridData, dataManagerRequest.Where, dataManagerRequest.Where[0].Operator);
            }
            if (dataManagerRequest.Sorted?.Count > 0) // perform Sorting
            {
                GridData = DataOperations.PerformSorting(GridData, dataManagerRequest.Sorted);
            }
            if (dataManagerRequest.Skip != 0)
            {
                GridData = DataOperations.PerformSkip(GridData, dataManagerRequest.Skip); //Paging
            }
            if (dataManagerRequest.Take != 0)
            {
                GridData = DataOperations.PerformTake(GridData, dataManagerRequest.Take);
            }
            IDictionary<string, object> aggregates = new Dictionary<string, object>();
            if (dataManagerRequest.Aggregates != null) // Aggregation
            {
                aggregates = DataUtil.PerformAggregation(GridData, dataManagerRequest.Aggregates);
            }
            if (dataManagerRequest.Group != null && dataManagerRequest.Group.Any()) //Grouping
            {
                foreach (var group in dataManagerRequest.Group)
                {
                    GridData = DataUtil.Group<JobDescription>(GridData, group, dataManagerRequest.Aggregates, 0, dataManagerRequest.GroupByFormatter);
                }
            }
            return dataManagerRequest.RequiresCounts ? new DataResult() { Result = GridData, Count = _count, Aggregates = aggregates } : (object)GridData;
        }
        public override async Task<Object> InsertAsync(DataManager dataManager, object value, string key)
        {
            try
            {

                var val = (value as JobDescription);
                if(val != null)
                {
                    if (val.JobDescriptionId == 0)
                    {

                        string json = Newtonsoft.Json.JsonConvert.SerializeObject(val);
                        StringContent httpContent = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

                        var result = await Http.PostAsync($"HumanResource/PostJobDescription", httpContent);
                        if (result.IsSuccessStatusCode)
                        {
                            var content = await result.Content.ReadAsStringAsync();
                            var data = JsonSerializer.Deserialize<Response>(content, _options);
                            if(data != null)
                            {
                                if (data.IsSuccess)
                                {
                                    toastService.ShowSuccess(data.Message);
                                }
                                else
                                {
                                    toastService.ShowError(data.Message);
                                }
                            }
                        }
                        else
                        {
                            toastService.ShowError(result.ReasonPhrase);
                        }

                    }
                    else
                    {

                        string json = Newtonsoft.Json.JsonConvert.SerializeObject(val);
                        StringContent httpContent = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

                        var result = await Http.PutAsync($"HumanResource/PutJobDescription", httpContent);
                        if (result.IsSuccessStatusCode)
                        {
                            var content = await result.Content.ReadAsStringAsync();
                            var data = JsonSerializer.Deserialize<Response>(content, _options);
                            if(data != null)
                            {
                                if (data.IsSuccess)
                                {
                                    toastService.ShowSuccess(data.Message);
                                }
                                else
                                {
                                    toastService.ShowError(data.Message);
                                }
                            }
                        }
                        else
                        {
                            toastService.ShowError(result.ReasonPhrase);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                toastService.ShowError(ex.Message.ToString());
            }
            return value;
        }
        public override async Task<object> RemoveAsync(DataManager dataManager, object value, string keyField, string key)
        {
            //try
            //{
            //    int data = (int)value;
            //    using (var dbContext = new MUCOBADIContext())
            //    {
            //        var exists = dbContext.AAdministrationPhase.FirstOrDefault(o => o.AdministrationPhaseId == data);
            //        if (exists != null)
            //        {
            //            dbContext.AAdministrationPhase.Remove(exists);
            //        }
            //        await dbContext.SaveChangesAsync();
            //    }
            //}
            //catch (Exception ex)
            //{
            //    toastService.ShowError(ex.Message.ToString());
            //}


            return value;
        }
        public override async Task<object> UpdateAsync(DataManager dataManager, object value, string keyField, string key)
        {
            try
            {

                var val = (value as JobDescription);
                if(val != null)
                {
                    if (val.JobDescriptionId == 0)
                    {

                        string json = Newtonsoft.Json.JsonConvert.SerializeObject(val);
                        StringContent httpContent = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

                        var result = await Http.PostAsync($"HumanResource/PostJobDescription", httpContent);
                        if (result.IsSuccessStatusCode)
                        {
                            var content = await result.Content.ReadAsStringAsync();
                            var data = JsonSerializer.Deserialize<Response>(content, _options);
                            if(data != null)
                            {
                                if (data.IsSuccess)
                                {
                                    toastService.ShowSuccess(data.Message);
                                }
                                else
                                {
                                    toastService.ShowError(data.Message);
                                }
                            }
                        }
                        else
                        {
                            toastService.ShowError(result.ReasonPhrase);
                        }

                    }
                    else
                    {

                        string json = Newtonsoft.Json.JsonConvert.SerializeObject(val);
                        StringContent httpContent = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

                        var result = await Http.PutAsync($"HumanResource/PutJobDescription", httpContent);
                        if (result.IsSuccessStatusCode)
                        {
                            var content = await result.Content.ReadAsStringAsync();
                            var data = JsonSerializer.Deserialize<Response>(content, _options);
                            if(data != null)
                            {
                                if (data.IsSuccess)
                                {
                                    toastService.ShowSuccess(data.Message);
                                }
                                else
                                {
                                    toastService.ShowError(data.Message);
                                }
                            }
                        }
                        else
                        {
                            toastService.ShowError(result.ReasonPhrase);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                toastService.ShowError(ex.Message.ToString());
            }

            return value;
        }
        public override async Task<object> BatchUpdateAsync(DataManager dm, object Changed, object Added, object Deleted, string KeyField, string Key, int? dropIndex)
        {
            object? products = null;
            try
            {

                if (Changed != null)
                {
                    products = Changed;
                    foreach (var val in (List<JobDescription>)Changed)
                    {
                        if(val != null)
                        {
                            if (val.JobDescriptionId == 0)
                            {

                                string json = Newtonsoft.Json.JsonConvert.SerializeObject(val);
                                StringContent httpContent = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

                                var result = await Http.PostAsync($"HumanResource/PostJobDescription", httpContent);
                                if (result.IsSuccessStatusCode)
                                {
                                    var content = await result.Content.ReadAsStringAsync();
                                    var data = JsonSerializer.Deserialize<Response>(content, _options);
                                    if(data != null)
                                    {
                                        if (data.IsSuccess)
                                        {
                                            toastService.ShowSuccess(data.Message);
                                        }
                                        else
                                        {
                                            toastService.ShowError(data.Message);
                                        }
                                    }
                                }
                                else
                                {
                                    toastService.ShowError(result.ReasonPhrase);
                                }

                            }
                            else
                            {

                                string json = Newtonsoft.Json.JsonConvert.SerializeObject(val);
                                StringContent httpContent = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

                                var result = await Http.PutAsync($"HumanResource/PutJobDescription", httpContent);
                                if (result.IsSuccessStatusCode)
                                {
                                    var content = await result.Content.ReadAsStringAsync();
                                    var data = JsonSerializer.Deserialize<Response>(content, _options);
                                    if(data != null)
                                    {
                                        if (data.IsSuccess)
                                        {
                                            toastService.ShowSuccess(data.Message);
                                        }
                                        else
                                        {
                                            toastService.ShowError(data.Message);
                                        }
                                    }
                                }
                                else
                                {
                                    toastService.ShowError(result.ReasonPhrase);
                                }
                            }
                        }
                    }

                }
                if (Added != null)
                {
                    products = Added;
                    foreach (var val in (List<JobDescription>)Added)
                    {
                        if(val != null)
                        {
                            if (val.JobDescriptionId == 0)
                            {

                                string json = Newtonsoft.Json.JsonConvert.SerializeObject(val);
                                StringContent httpContent = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

                                var result = await Http.PostAsync($"HumanResource/PostJobDescription", httpContent);
                                if (result.IsSuccessStatusCode)
                                {
                                    var content = await result.Content.ReadAsStringAsync();
                                    var data = JsonSerializer.Deserialize<Response>(content, _options);
                                    if(data != null)
                                    {
                                        if (data.IsSuccess)
                                        {
                                            toastService.ShowSuccess(data.Message);
                                        }
                                        else
                                        {
                                            toastService.ShowError(data.Message);
                                        }
                                    }
                                }
                                else
                                {
                                    toastService.ShowError(result.ReasonPhrase);
                                }

                            }
                            else
                            {

                                string json = Newtonsoft.Json.JsonConvert.SerializeObject(val);
                                StringContent httpContent = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

                                var result = await Http.PutAsync($"HumanResource/PutJobDescription", httpContent);
                                if (result.IsSuccessStatusCode)
                                {
                                    var content = await result.Content.ReadAsStringAsync();
                                    var data = JsonSerializer.Deserialize<Response>(content, _options);
                                    if(data != null)
                                    {
                                        if (data.IsSuccess)
                                        {
                                            toastService.ShowSuccess(data.Message);
                                        }
                                        else
                                        {
                                            toastService.ShowError(data.Message);
                                        }
                                    }
                                }
                                else
                                {
                                    toastService.ShowError(result.ReasonPhrase);
                                }
                            }
                        }
                    }

                }
                if (Deleted != null)
                {
                    products = Deleted;
                    //foreach (var rec in (List<OrderDetails>)Deleted)
                    //{
                    //    Orders.Remove(Orders.Where(or => or.OrderID == rec.OrderID).FirstOrDefault());
                    //}

                }
            }
            catch (Exception ex)
            {
                toastService.ShowError(ex.Message.ToString());
            }
            return products;
        }
    }
    public async Task OnJobDescriptionActionBegin(ActionEventArgs<JobDescription> args)
    {
        try
        {
            if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add) || args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.BeginEdit))
            {
                ChildQuery = new();
                ChildQuery.AddParams("JobDescriptionId", args.RowData.JobDescriptionId);
                //JobDescriptionGrid.PreventRender(false);
            }
            if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Save))
            {                
                if (args.Data.JibTitleId == null)
                {
                    toastService.ClearAll();
                    toastService.ShowWarning("Please select the Job Title !");
                    args.Cancel = true;
                    await JSRuntime.InvokeVoidAsync("RequiredFieldFunction");
                }
                else if (args.Data.DepartmentId == null)
                {
                    toastService.ClearAll();
                    toastService.ShowWarning("Please select the department !");
                    args.Cancel = true;
                    await JSRuntime.InvokeVoidAsync("RequiredFieldFunction");
                }
                else if (args.Data.JobTypeId == null)
                {
                    toastService.ClearAll();
                    toastService.ShowWarning("Please select the job type !");
                    args.Cancel = true;
                    await JSRuntime.InvokeVoidAsync("RequiredFieldFunction");
                }

                else if (args.Data.MinimumLevelOfEducationId == null)
                {
                    toastService.ClearAll();
                    toastService.ShowWarning("Please select the minimum education level required !");
                    args.Cancel = true;
                    await JSRuntime.InvokeVoidAsync("RequiredFieldFunction");
                }

                else if (args.Data.MinimumYearsofExperience == null)
                {
                    toastService.ClearAll();
                    toastService.ShowWarning("Please select the minimum years of experience required !");
                    args.Cancel = true;
                    await JSRuntime.InvokeVoidAsync("RequiredFieldFunction");
                }

                else if (args.Data.Vacancies == null)
                {
                    toastService.ClearAll();
                    toastService.ShowWarning("Please enter the number of vacancies !");
                    args.Cancel = true;
                    await JSRuntime.InvokeVoidAsync("RequiredFieldFunction");
                }

                else if (string.IsNullOrEmpty(args.Data.RequiredWorkExperience))
                {
                    toastService.ClearAll();
                    toastService.ShowWarning("Please enter the required experience details!");
                    args.Cancel = true;
                    await JSRuntime.InvokeVoidAsync("RequiredFieldFunction");
                }

                else if (string.IsNullOrEmpty(args.Data.Qualification))
                {
                    toastService.ClearAll();
                    toastService.ShowWarning("Please enter the required qualification(s)!");
                    args.Cancel = true;
                    await JSRuntime.InvokeVoidAsync("RequiredFieldFunction");
                }

                else if (args.Data.JobDescription1 == null)
                {
                    toastService.ClearAll();
                    toastService.ShowWarning("Please enter the duties and responsibilities !");
                    args.Cancel = true;
                    await JSRuntime.InvokeVoidAsync("RequiredFieldFunction");
                }
                else
                {
                    SavingDialog.ShowAsync();
                }
            }
        }
        catch (Exception ex)
        {
            await ToastObj.ShowAsync(new ToastModel { Title = "Error!", Content = ex.Message.ToString(), CssClass = "e-toast-danger", Icon = "e-error toast-icons" });
        }

    }
    
    public async Task OnJobDescriptionActionComplete(ActionEventArgs<JobDescription> args)
    {
        try
        {
            if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add) || args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.BeginEdit))
            {
                JobDescriptionGrid.PreventRender(false);
            }
            if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Save))
            {
                SavingDialog.HideAsync();
            }
        }
        catch(Exception ex)
        {
            await ToastObj.ShowAsync(new ToastModel { Title = "Error!", Content = ex.Message.ToString(), CssClass = "e-toast-danger", Icon = "e-error toast-icons" });
        }

    }
   
    public string GetJobDescriptionHeader(JobDescription Value)
    {
        if (Value.JobDescriptionId == 0)
        {
            return "Add New Job Description";
        }
        else
        {
            string? Desc = string.Empty;
            if(JobTitleData != null){
                var data = JobTitleData.FirstOrDefault(o => o.JobTitleId == Value.JibTitleId);
                if(data != null){
                    Desc = data.JobTitleDescription;
                }
            }
            return "Edit Details for " + Desc;
        }
    }

}